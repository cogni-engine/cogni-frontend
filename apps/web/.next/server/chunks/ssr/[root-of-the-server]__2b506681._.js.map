{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 49, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/AIMessageView.tsx"],"sourcesContent":["'use client';\n\nimport React, { useState } from 'react';\nimport ReactMarkdown from 'react-markdown';\nimport remarkGfm from 'remark-gfm';\nimport { cn } from '@/lib/utils';\nimport { Components } from 'react-markdown';\nimport { Copy, Check } from 'lucide-react';\n\ntype AIMessageViewProps = {\n  content: string;\n  className?: string;\n};\n\n// Extracted component to satisfy React Hooks rule (component names must be Capitalized)\nconst PreBlock = ({\n  children,\n  ...rest\n}: React.HTMLAttributes<HTMLPreElement>) => {\n  const [copied, setCopied] = useState(false);\n\n  // preの中のcode要素からテキストを抽出\n  const extractCodeText = (node: React.ReactNode): string => {\n    if (typeof node === 'string') return node;\n    if (typeof node === 'number') return String(node);\n    if (React.isValidElement(node)) {\n      if (node.type === 'code') {\n        const props = node.props as { children?: React.ReactNode };\n        return extractCodeText(props.children || '');\n      }\n      const props = node.props as { children?: React.ReactNode };\n      if (props.children) {\n        return React.Children.toArray(props.children)\n          .map(child => extractCodeText(child))\n          .join('');\n      }\n    }\n    if (Array.isArray(node)) {\n      return node.map(child => extractCodeText(child)).join('');\n    }\n    return '';\n  };\n\n  const codeText = extractCodeText(children);\n\n  const handleCopy = async () => {\n    if (!codeText) return;\n    try {\n      await navigator.clipboard.writeText(codeText);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error('コピーに失敗しました:', err);\n    }\n  };\n\n  return (\n    <div className='my-3 relative'>\n      <pre\n        className='overflow-x-auto rounded-2xl border border-white/10 p-5 text-sm text-gray-400'\n        style={{ overscrollBehaviorX: 'contain', overscrollBehaviorY: 'auto' }}\n        {...rest}\n      >\n        {children}\n      </pre>\n      <button\n        onClick={handleCopy}\n        className='absolute top-1 right-2 flex items-center gap-1.5 px-3 py-1.5 rounded-xl border-black text-white/70 text-sm transition-colors'\n      >\n        {copied ? <Check className='w-4 h-4' /> : <Copy className='w-4 h-4' />}\n        <span>{copied ? 'Copied' : 'Copy'}</span>\n      </button>\n    </div>\n  );\n};\n\nexport const AIMessageView = ({ content, className }: AIMessageViewProps) => {\n  const customComponents: Components = {\n    h1: ({ children }) => (\n      <h1 className='my-3 text-lg font-semibold text-white'>{children}</h1>\n    ),\n    h2: ({ children }) => (\n      <h2 className='my-2 text-base font-semibold text-white'>{children}</h2>\n    ),\n    h3: ({ children }) => (\n      <h3 className='my-2 text-sm font-semibold text-white'>{children}</h3>\n    ),\n    p: ({ children }) => (\n      <p className='my-2 text-sm leading-7 text-gray-200'>{children}</p>\n    ),\n    code: ({ children, className }) => {\n      const isCodeBlock = className?.startsWith('language-');\n\n      if (isCodeBlock) {\n        return <code className={`${className} text-gray-400`}>{children}</code>;\n      }\n\n      return (\n        <code className='rounded bg-neutral-800 px-1.5 py-0.5 text-sm text-gray-200'>\n          {children}\n        </code>\n      );\n    },\n    pre: PreBlock,\n    a: ({ children, href }) => (\n      <a\n        href={href}\n        target='_blank'\n        rel='noopener noreferrer'\n        className='text-blue-400 underline hover:text-blue-300'\n      >\n        {children}\n      </a>\n    ),\n    ul: ({ children }) => (\n      <ul className='my-3 ml-6 list-disc space-y-1 text-gray-200'>\n        {children}\n      </ul>\n    ),\n    ol: ({ children }) => (\n      <ol className='my-3 ml-6 list-decimal space-y-1 text-gray-200'>\n        {children}\n      </ol>\n    ),\n    li: ({ children }) => <li className='text-gray-200'>{children}</li>,\n    strong: ({ children }) => (\n      <strong className='font-semibold text-white'>{children}</strong>\n    ),\n    em: ({ children }) => <em className='italic text-gray-100'>{children}</em>,\n  };\n\n  if (!content) return null;\n\n  return (\n    <div className={cn('w-full text-sm md:text-base', className)}>\n      <ReactMarkdown remarkPlugins={[remarkGfm]} components={customComponents}>\n        {content}\n      </ReactMarkdown>\n    </div>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 285, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/TimerDisplay.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useState, useRef } from 'react';\nimport { TimerState } from '@/types/chat';\n\ntype TimerDisplayProps = {\n  timer: TimerState;\n  sendMessage: (\n    content: string,\n    notificationId?: number,\n    timerCompleted?: boolean\n  ) => Promise<void>;\n  threadId: number;\n};\n\nexport const TimerDisplay: React.FC<TimerDisplayProps> = ({\n  timer,\n  sendMessage,\n  threadId: _threadId, // eslint-disable-line @typescript-eslint/no-unused-vars\n}) => {\n  const [remainingSeconds, setRemainingSeconds] = useState<number>(0);\n  const hasCompleted = useRef(false);\n\n  // デバッグ用ログ\n  console.log('TimerDisplay rendered with timer:', timer);\n  console.log('Timer status:', timer.status);\n  console.log('Timer ends_at:', timer.ends_at);\n\n  useEffect(() => {\n    console.log('TimerDisplay useEffect triggered');\n    // 残り時間を計算する関数\n    const calculateRemaining = () => {\n      const endsAt = new Date(timer.ends_at);\n      const now = new Date();\n\n      // デバッグログ追加\n      console.log('=== Timer Timezone Debug ===');\n      console.log('timer.ends_at (raw):', timer.ends_at);\n      console.log('endsAt (parsed):', endsAt.toISOString());\n      console.log('endsAt (local):', endsAt.toString());\n      console.log('now (UTC):', now.toISOString());\n      console.log('now (local):', now.toString());\n      console.log('endsAt timestamp:', endsAt.getTime());\n      console.log('now timestamp:', now.getTime());\n      console.log('difference (ms):', endsAt.getTime() - now.getTime());\n\n      const remaining = Math.max(\n        0,\n        Math.floor((endsAt.getTime() - now.getTime()) / 1000)\n      );\n      console.log('Calculated remaining seconds:', remaining);\n      console.log('===========================');\n\n      return remaining;\n    };\n\n    // 初期値を設定\n    const initialRemaining = calculateRemaining();\n    setRemainingSeconds(initialRemaining);\n    console.log('Initial remaining seconds set to:', initialRemaining);\n\n    // 2秒前に送信するための閾値チェック\n    const EARLY_SEND_SECONDS = 1;\n\n    // 1秒ごとに更新\n    const interval = setInterval(() => {\n      const remaining = calculateRemaining();\n      setRemainingSeconds(remaining);\n\n      if (remaining === 0) {\n        clearInterval(interval);\n        return;\n      }\n\n      // 残り1秒になったら送信\n      if (remaining === EARLY_SEND_SECONDS && !hasCompleted.current) {\n        hasCompleted.current = true;\n        console.log('Timer reached 1 seconds remaining, calling sendMessage');\n        sendMessage('', undefined, true).catch(err => {\n          console.error('Error completing timer:', err);\n        });\n      }\n    }, 1000);\n\n    return () => clearInterval(interval);\n  }, [timer, sendMessage]); // timer, sendMessageに依存\n\n  console.log('Current remainingSeconds:', remainingSeconds);\n  console.log('Timer status check:', timer.status === 'completed');\n  console.log(\n    'Will render?',\n    !(remainingSeconds === 0 || timer.status === 'completed')\n  );\n\n  // 時間切れまたはcompleted → 非表示\n  if (remainingSeconds === 0 || timer.status === 'completed') {\n    console.log('TimerDisplay returning null');\n    return null;\n  }\n\n  // const totalSeconds = timer.duration_seconds || timer.duration_minutes * 60;\n  // const progress =\n  //   totalSeconds > 0 ? (remainingSeconds / totalSeconds) * 100 : 0;\n\n  // 残り時間をMM:SS形式に変換（先行ゼロ付き）\n  const minutes = Math.floor(remainingSeconds / 60);\n  const seconds = remainingSeconds % 60;\n  const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\n\n  console.log('TimerDisplay rendering with timeDisplay:', timeDisplay);\n\n  return (\n    <div className='flex justify-start items-center my-6 px-2'>\n      <div className='bg-black/20 backdrop-blur-xl rounded-[20px] px-6 py-2 flex items-center justify-between min-w-[270px] border border-white/5 shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)] hover:shadow-[0_12px_40px_rgba(0,0,0,0.25),inset_0_1px_0_rgba(255,255,255,0.18)] transition-all duration-300'>\n        {/* 左側: 時間表示 */}\n        <div className='flex flex-col items-start'>\n          <div className='text-3xl font-light text-white tracking-tight'>\n            {timeDisplay}\n          </div>\n          <div className='text-sm text-white/60 font-normal mt-1 px-2'>\n            Timer\n          </div>\n        </div>\n\n        {/* 右側: 一時停止ボタン */}\n        <div className='relative'>\n          {/* 一時停止ボタン - 円の中にアイコン */}\n          <button className='w-12 h-12 rounded-full border-2 border-orange-400 bg-transparent flex items-center justify-center hover:bg-orange-400/10 transition-colors'>\n            <div className='flex space-x-1'>\n              <div className='w-1 h-4 bg-orange-400 rounded-full'></div>\n              <div className='w-1 h-4 bg-orange-400 rounded-full'></div>\n            </div>\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 449, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/AIInitiatedMessageWrapper.tsx"],"sourcesContent":["'use client';\n\nimport React from 'react';\n\ntype AIInitiatedMessageWrapperProps = {\n  children: React.ReactNode;\n};\n\nexport const AIInitiatedMessageWrapper = ({\n  children,\n}: AIInitiatedMessageWrapperProps) => {\n  return (\n    <div\n      className='\n      border border-white/20 \n      shadow-[0_0_5px_rgba(255,255,255,0.4)]\n      bg-white/3\n      backdrop-blur-md\n      rounded-[1.618rem]\n      px-6\n      py-2\n    '\n    >\n      {children}\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;AAAA;;AAQO,MAAM,4BAA4B,CAAC,EACxC,QAAQ,EACuB;IAC/B,qBACE,keAAC;QACC,WAAU;kBAUT;;;;;;AAGP","debugId":null}},
    {"offset": {"line": 470, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/MessageItem.tsx"],"sourcesContent":["import { Message, AIMessage } from '@/types/chat';\nimport { AIMessageView } from './AIMessageView';\nimport { TimerDisplay } from './TimerDisplay';\nimport { AIInitiatedMessageWrapper } from './AIInitiatedMessageWrapper';\n\ntype MessageItemProps = {\n  message: Message | AIMessage;\n  sendMessage: (\n    content: string,\n    notificationId?: number,\n    timerCompleted?: boolean\n  ) => Promise<void>;\n};\n\nexport default function MessageItem({\n  message,\n  sendMessage,\n}: MessageItemProps) {\n  // assistantメッセージは常にAIMessageViewを使用（Markdownサポート）\n  if (message.role === 'assistant') {\n    const hasTimer = 'meta' in message && message.meta?.timer;\n    const isAIInitiated =\n      'meta' in message && message.meta?.is_ai_initiated === true;\n\n    return (\n      <div className='w-full max-w-5xl mx-auto mb-6 px-1 md:px-3'>\n        {isAIInitiated ? (\n          <AIInitiatedMessageWrapper>\n            <AIMessageView content={message.content} />\n          </AIInitiatedMessageWrapper>\n        ) : (\n          <AIMessageView content={message.content} />\n        )}\n\n        {/* タイマー表示 - TimerDisplayが完全自己完結 */}\n        {hasTimer &&\n          'meta' in message &&\n          message.meta?.timer &&\n          'thread_id' in message && (\n            <TimerDisplay\n              timer={message.meta.timer}\n              sendMessage={sendMessage}\n              threadId={message.thread_id}\n            />\n          )}\n      </div>\n    );\n  }\n\n  // ユーザーメッセージの場合 - ChatGPT風の右寄せスタイル\n  return (\n    <div className='w-full max-w-5xl mx-auto flex justify-end mb-4 px-1 md:px-3'>\n      <div className='max-w-[75%] rounded-3xl px-4 py-2.5 bg-white/8 backdrop-blur-xl border border-black shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)]'>\n        <div className='text-sm md:text-sm text-white whitespace-pre-line'>\n          {message.content}\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AACA;AACA;AACA;;;;;AAWe,SAAS,YAAY,EAClC,OAAO,EACP,WAAW,EACM;IACjB,kDAAkD;IAClD,IAAI,QAAQ,IAAI,KAAK,aAAa;QAChC,MAAM,WAAW,UAAU,WAAW,QAAQ,IAAI,EAAE;QACpD,MAAM,gBACJ,UAAU,WAAW,QAAQ,IAAI,EAAE,oBAAoB;QAEzD,qBACE,keAAC;YAAI,WAAU;;gBACZ,8BACC,keAAC,sPAAyB;8BACxB,cAAA,keAAC,8NAAa;wBAAC,SAAS,QAAQ,OAAO;;;;;;;;;;yCAGzC,keAAC,8NAAa;oBAAC,SAAS,QAAQ,OAAO;;;;;;gBAIxC,YACC,UAAU,WACV,QAAQ,IAAI,EAAE,SACd,eAAe,yBACb,keAAC,4NAAY;oBACX,OAAO,QAAQ,IAAI,CAAC,KAAK;oBACzB,aAAa;oBACb,UAAU,QAAQ,SAAS;;;;;;;;;;;;IAKvC;IAEA,kCAAkC;IAClC,qBACE,keAAC;QAAI,WAAU;kBACb,cAAA,keAAC;YAAI,WAAU;sBACb,cAAA,keAAC;gBAAI,WAAU;0BACZ,QAAQ,OAAO;;;;;;;;;;;;;;;;AAK1B","debugId":null}},
    {"offset": {"line": 553, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/EmptyState.tsx"],"sourcesContent":["export default function EmptyState() {\n  return (\n    <div className='flex flex-col items-center justify-center h-full text-center'>\n      <div className='w-20 h-20 flex items-center justify-center mb-6'>\n        <div className='relative'>\n          {/* 彗星の核 */}\n          <div className='w-4 h-4 bg-white rounded-full shadow-lg'></div>\n          {/* アシンメトリーな彗星の尾 */}\n          <div className='absolute top-1/2 left-0 w-16 h-0.5 bg-gradient-to-r from-white/60 via-white/30 to-transparent transform -translate-y-1/2'></div>\n          <div className='absolute top-1/2 left-0 w-14 h-0.5 bg-gradient-to-r from-white/40 via-white/20 to-transparent transform -translate-y-1/2 translate-y-2'></div>\n          <div className='absolute top-1/2 left-0 w-12 h-0.5 bg-gradient-to-r from-white/30 via-white/15 to-transparent transform -translate-y-1/2 -translate-y-2'></div>\n          <div className='absolute top-1/2 left-0 w-10 h-0.5 bg-gradient-to-r from-white/20 via-white/10 to-transparent transform -translate-y-1/2 translate-y-3'></div>\n          <div className='absolute top-1/2 left-0 w-8 h-0.5 bg-gradient-to-r from-white/15 via-white/5 to-transparent transform -translate-y-1/2 -translate-y-3'></div>\n        </div>\n      </div>\n      <h2 className='text-2xl font-bold text-white mb-3 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent'>\n        Cogno\n      </h2>\n      <p className='text-gray-400 max-w-md text-lg'>\n        The space between thought and creation.\n      </p>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;;AAAe,SAAS;IACtB,qBACE,keAAC;QAAI,WAAU;;0BACb,keAAC;gBAAI,WAAU;0BACb,cAAA,keAAC;oBAAI,WAAU;;sCAEb,keAAC;4BAAI,WAAU;;;;;;sCAEf,keAAC;4BAAI,WAAU;;;;;;sCACf,keAAC;4BAAI,WAAU;;;;;;sCACf,keAAC;4BAAI,WAAU;;;;;;sCACf,keAAC;4BAAI,WAAU;;;;;;sCACf,keAAC;4BAAI,WAAU;;;;;;;;;;;;;;;;;0BAGnB,keAAC;gBAAG,WAAU;0BAA2G;;;;;;0BAGzH,keAAC;gBAAE,WAAU;0BAAiC;;;;;;;;;;;;AAKpD","debugId":null}},
    {"offset": {"line": 648, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/MessageList.tsx"],"sourcesContent":["import { Message, AIMessage } from '@/types/chat';\nimport MessageItem from './MessageItem';\nimport EmptyState from './EmptyState';\n\ntype MessageListProps = {\n  messages: Message[] | AIMessage[];\n  sendMessage: (\n    content: string,\n    notificationId?: number,\n    timerCompleted?: boolean\n  ) => Promise<void>;\n};\n\nexport default function MessageList({\n  messages,\n  sendMessage,\n}: MessageListProps) {\n  if (messages.length === 0) {\n    return <EmptyState />;\n  }\n\n  return (\n    <>\n      {messages.map((message, i) => {\n        // より安全なkey生成: ID + インデックスで一意性を保証\n        const messageId =\n          'id' in message && typeof message.id === 'number'\n            ? message.id\n            : `temp-${i}`;\n        const key = `${messageId}-${i}`;\n\n        return (\n          <div key={key} data-message-index={i}>\n            <MessageItem message={message} sendMessage={sendMessage} />\n          </div>\n        );\n      })}\n      <div className='h-120'></div>\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;AACA;AACA;;;;AAWe,SAAS,YAAY,EAClC,QAAQ,EACR,WAAW,EACM;IACjB,IAAI,SAAS,MAAM,KAAK,GAAG;QACzB,qBAAO,keAAC,qNAAU;;;;;IACpB;IAEA,qBACE;;YACG,SAAS,GAAG,CAAC,CAAC,SAAS;gBACtB,iCAAiC;gBACjC,MAAM,YACJ,QAAQ,WAAW,OAAO,QAAQ,EAAE,KAAK,WACrC,QAAQ,EAAE,GACV,CAAC,KAAK,EAAE,GAAG;gBACjB,MAAM,MAAM,GAAG,UAAU,CAAC,EAAE,GAAG;gBAE/B,qBACE,keAAC;oBAAc,sBAAoB;8BACjC,cAAA,keAAC,sNAAW;wBAAC,SAAS;wBAAS,aAAa;;;;;;mBADpC;;;;;YAId;0BACA,keAAC;gBAAI,WAAU;;;;;;;;AAGrB","debugId":null}},
    {"offset": {"line": 702, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/cogno/components/ChatContainer.tsx"],"sourcesContent":["import { Message, AIMessage } from '@/types/chat';\nimport { forwardRef } from 'react';\nimport MessageList from './MessageList';\n\ntype ChatContainerProps = {\n  messages: Message[] | AIMessage[];\n  sendMessage: (\n    content: string,\n    notificationId?: number,\n    timerCompleted?: boolean\n  ) => Promise<void>;\n};\n\nconst ChatContainer = forwardRef<HTMLDivElement, ChatContainerProps>(\n  ({ messages, sendMessage }, ref) => {\n    return (\n      <div className='flex-1 bg-gradient-to-br from-slate-950 via-black to-slate-950 relative overflow-hidden'>\n        {/* メッセージエリア - GPU最適化 */}\n        <div\n          ref={ref}\n          className='h-full overflow-y-auto relative z-10 p-6 md:p-8 space-y-6 scroll-smooth'\n          style={{\n            willChange: 'scroll-position',\n            transform: 'translateZ(0)',\n            WebkitOverflowScrolling: 'touch',\n          }}\n        >\n          <MessageList messages={messages} sendMessage={sendMessage} />\n        </div>\n      </div>\n    );\n  }\n);\n\nChatContainer.displayName = 'ChatContainer';\n\nexport default ChatContainer;\n"],"names":[],"mappings":";;;;;AACA;AACA;;;;AAWA,MAAM,8BAAgB,IAAA,ucAAU,EAC9B,CAAC,EAAE,QAAQ,EAAE,WAAW,EAAE,EAAE;IAC1B,qBACE,keAAC;QAAI,WAAU;kBAEb,cAAA,keAAC;YACC,KAAK;YACL,WAAU;YACV,OAAO;gBACL,YAAY;gBACZ,WAAW;gBACX,yBAAyB;YAC3B;sBAEA,cAAA,keAAC,sNAAW;gBAAC,UAAU;gBAAU,aAAa;;;;;;;;;;;;;;;;AAItD;AAGF,cAAc,WAAW,GAAG;uCAEb","debugId":null}},
    {"offset": {"line": 748, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/VoiceInputButton.tsx"],"sourcesContent":["'use client';\n\nimport { Mic } from 'lucide-react';\nimport {\n  useState,\n  useRef,\n  useEffect,\n  forwardRef,\n  useImperativeHandle,\n} from 'react';\n\n// 音声認識APIの型定義\ninterface SpeechRecognitionResult {\n  isFinal: boolean;\n  [index: number]: {\n    transcript: string;\n  };\n}\n\ninterface SpeechRecognitionResultList {\n  length: number;\n  item(index: number): SpeechRecognitionResult;\n  [index: number]: SpeechRecognitionResult;\n}\n\ninterface SpeechRecognitionEvent extends Event {\n  resultIndex: number;\n  results: SpeechRecognitionResultList;\n}\n\ninterface SpeechRecognition extends EventTarget {\n  continuous: boolean;\n  interimResults: boolean;\n  lang: string;\n  start(): void;\n  stop(): void;\n  onresult: (event: SpeechRecognitionEvent) => void;\n  onerror: (event: { error: string; message?: string }) => void;\n  onend: () => void;\n}\n\ndeclare global {\n  interface Window {\n    SpeechRecognition: {\n      new (): SpeechRecognition;\n    };\n    webkitSpeechRecognition: {\n      new (): SpeechRecognition;\n    };\n  }\n}\n\ninterface VoiceInputButtonProps {\n  onTranscriptChange: (text: string) => void;\n  currentText?: string;\n  disabled?: boolean;\n  className?: string;\n}\n\nexport interface VoiceInputButtonRef {\n  restartRecording: () => void;\n}\n\nexport const VoiceInputButton = forwardRef<\n  VoiceInputButtonRef,\n  VoiceInputButtonProps\n>(\n  (\n    { onTranscriptChange, currentText = '', disabled = false, className = '' },\n    ref\n  ) => {\n    const [isRecording, setIsRecording] = useState(false);\n    const recognitionRef = useRef<SpeechRecognition | null>(null);\n    const finalTranscriptRef = useRef<string>('');\n    const lastInterimTranscriptRef = useRef<string>('');\n    const processedResultIndexRef = useRef<number>(0);\n\n    // 現在のテキストが変更されたら、finalTranscriptRefを更新\n    useEffect(() => {\n      if (!isRecording) {\n        finalTranscriptRef.current = currentText;\n      }\n    }, [currentText, isRecording]);\n\n    // クリーンアップ\n    useEffect(() => {\n      return () => {\n        if (recognitionRef.current) {\n          recognitionRef.current.stop();\n        }\n      };\n    }, []);\n\n    // Expose restartRecording method to parent\n    useImperativeHandle(ref, () => ({\n      restartRecording: () => {\n        if (isRecording) {\n          // Stop current recording\n          if (recognitionRef.current) {\n            recognitionRef.current.stop();\n            recognitionRef.current = null;\n          }\n          setIsRecording(false);\n          finalTranscriptRef.current = '';\n\n          onTranscriptChange('');\n          setTimeout(() => {\n            startRecording('');\n          }, 100);\n        }\n      },\n    }));\n\n    const startRecording = (overrideText?: string) => {\n      const SpeechRecognition =\n        window.SpeechRecognition || window.webkitSpeechRecognition;\n      if (!SpeechRecognition) {\n        console.error('音声認識APIがサポートされていません');\n        return;\n      }\n\n      // 録音開始時に現在のテキストを保存（overrideTextがあればそれを使用）\n      finalTranscriptRef.current =\n        overrideText !== undefined ? overrideText : currentText;\n      // 未確定文字列をリセット\n      lastInterimTranscriptRef.current = '';\n      // 処理済みの結果インデックスをリセット\n      processedResultIndexRef.current = 0;\n\n      const recognition = new SpeechRecognition();\n      recognitionRef.current = recognition;\n\n      recognition.lang = 'ja-JP';\n      recognition.continuous = true;\n      recognition.interimResults = true;\n\n      recognition.onresult = (event: SpeechRecognitionEvent) => {\n        // ベースとなる確定済み文字列\n        let finalTranscript = finalTranscriptRef.current;\n\n        // 処理済みの確定済み結果以降から、新しい確定済み結果を順番に追加\n        // event.resultsには全ての結果が含まれるため、処理済み以降から追加する\n        const startIndex = processedResultIndexRef.current;\n        for (let i = startIndex; i < event.results.length; ++i) {\n          const result = event.results[i];\n          if (result.isFinal) {\n            const transcript = result[0].transcript;\n            finalTranscript += transcript;\n            finalTranscriptRef.current = finalTranscript;\n            // 処理済みインデックスを更新（この結果まで処理した）\n            processedResultIndexRef.current = i + 1;\n          }\n        }\n\n        // 最新の未確定結果を取得（処理済みの確定結果以降から探す）\n        // これにより、確定済みに含まれていない未確定結果のみを取得できる\n        let currentInterimTranscript = '';\n        const lastProcessedIndex = processedResultIndexRef.current;\n        for (let i = event.results.length - 1; i >= lastProcessedIndex; --i) {\n          const result = event.results[i];\n          if (!result.isFinal) {\n            currentInterimTranscript = result[0].transcript;\n            break; // 最新の未確定結果を取得\n          }\n        }\n\n        // 未確定文字列を更新\n        lastInterimTranscriptRef.current = currentInterimTranscript;\n\n        // 確定済み文字列 + 未確定文字列を表示\n        // 未確定が確定されたら、次のイベントで確定済みに置き換わる（重複なし）\n        const fullText = finalTranscript + currentInterimTranscript;\n        onTranscriptChange(fullText);\n      };\n\n      recognition.onerror = event => {\n        console.error('音声認識エラー:', event.error);\n        setIsRecording(false);\n      };\n\n      recognition.onend = () => {\n        console.log('音声認識が停止しました');\n        // ユーザーが手動で停止していない場合は自動で再起動\n        if (isRecording && recognitionRef.current) {\n          try {\n            recognitionRef.current.start();\n            console.log('音声認識を自動再起動します');\n          } catch (error) {\n            console.error('自動再起動エラー:', error);\n            setIsRecording(false);\n            recognitionRef.current = null;\n          }\n        }\n      };\n\n      try {\n        recognition.start();\n        setIsRecording(true);\n        console.log('音声認識開始');\n      } catch (error) {\n        console.error('音声認識の開始エラー:', error);\n      }\n    };\n\n    const handleVoiceInput = (event: React.MouseEvent<HTMLButtonElement>) => {\n      event.preventDefault();\n      event.stopPropagation();\n      if (!isRecording) {\n        startRecording();\n      } else {\n        // 0.5秒間は音声認識を続けてから停止\n        setTimeout(() => {\n          if (recognitionRef.current) {\n            try {\n              recognitionRef.current.stop();\n              console.log('音声認識停止');\n            } catch (error) {\n              console.error('音声認識停止エラー:', error);\n            }\n            recognitionRef.current = null;\n          }\n          setIsRecording(false);\n        }, 800);\n      }\n    };\n\n    const Icon = isRecording ? Mic : Mic;\n\n    return (\n      <button\n        onClick={handleVoiceInput}\n        disabled={disabled}\n        type='button'\n        title={isRecording ? '音声認識を停止' : '音声認識を開始'}\n        className={`${className} relative flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300`}\n      >\n        <Icon\n          className={`w-5 h-5 relative z-10 transition-colors duration-300 ${\n            isRecording ? 'text-white' : 'text-white/40'\n          }`}\n          style={isRecording ? { animationDuration: '1.5s' } : undefined}\n        />\n      </button>\n    );\n  }\n);\n\nVoiceInputButton.displayName = 'VoiceInputButton';\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 926, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/tiptap/MentionExtension.ts"],"sourcesContent":["import { createInlineMarkdownSpec, mergeAttributes } from '@tiptap/core';\nimport Mention from '@tiptap/extension-mention';\n\nexport interface MentionNodeAttrs {\n  id: string;\n  label: string;\n  workspaceMemberId: number;\n}\n\nexport const CustomMention = Mention.extend({\n  name: 'mention',\n\n  addAttributes() {\n    return {\n      id: {\n        default: null,\n        parseHTML: (element: HTMLElement) => element.getAttribute('data-id'),\n        renderHTML: (attributes: { id: string }) => {\n          if (!attributes.id) {\n            return {};\n          }\n          return {\n            'data-id': attributes.id,\n          };\n        },\n      },\n      label: {\n        default: null,\n        parseHTML: (element: HTMLElement) => element.getAttribute('data-label'),\n        renderHTML: (attributes: { label: string }) => {\n          if (!attributes.label) {\n            return {};\n          }\n          return {\n            'data-label': attributes.label,\n          };\n        },\n      },\n      workspaceMemberId: {\n        default: null,\n        parseHTML: (element: HTMLElement) => {\n          const id = element.getAttribute('data-workspace-member-id');\n          return id ? parseInt(id, 10) : null;\n        },\n        renderHTML: (attributes: { workspaceMemberId: number }) => {\n          if (!attributes.workspaceMemberId) {\n            return {};\n          }\n          return {\n            'data-workspace-member-id': attributes.workspaceMemberId,\n          };\n        },\n      },\n    };\n  },\n\n  parseHTML() {\n    return [\n      {\n        tag: 'span[data-type=\"mention\"]',\n      },\n    ];\n  },\n\n  renderHTML({\n    node,\n    HTMLAttributes,\n  }: {\n    node: Node;\n    HTMLAttributes: { [key: string]: string };\n  }) {\n    return [\n      'span',\n      mergeAttributes(\n        { 'data-type': 'mention' },\n        this.options.HTMLAttributes,\n        HTMLAttributes\n      ),\n      `@${HTMLAttributes['data-label'] || ''}`,\n    ];\n  },\n\n  renderText({ node }: { node: any }) {\n    return `@${node.attrs.label}`;\n  },\n\n  // Markdown support using Tiptap utility\n  ...createInlineMarkdownSpec({\n    nodeName: 'mention',\n    name: '@',\n    selfClosing: true,\n    allowedAttributes: ['id', 'label', 'workspaceMemberId'],\n  }),\n\n  addKeyboardShortcuts() {\n    return {\n      Backspace: () =>\n        this.editor.commands.command(({ tr, state }) => {\n          let isMention = false;\n          const { selection } = state;\n          const { empty, anchor } = selection;\n\n          if (!empty) {\n            return false;\n          }\n\n          state.doc.nodesBetween(anchor - 1, anchor, (node, pos) => {\n            if (node.type.name === this.name) {\n              isMention = true;\n              tr.insertText('', pos, pos + node.nodeSize);\n              return false;\n            }\n          });\n\n          return isMention;\n        }),\n    };\n  },\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQO,MAAM,gBAAgB,yaAAO,CAAC,MAAM,CAAC;IAC1C,MAAM;IAEN;QACE,OAAO;YACL,IAAI;gBACF,SAAS;gBACT,WAAW,CAAC,UAAyB,QAAQ,YAAY,CAAC;gBAC1D,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,EAAE,EAAE;wBAClB,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,WAAW,WAAW,EAAE;oBAC1B;gBACF;YACF;YACA,OAAO;gBACL,SAAS;gBACT,WAAW,CAAC,UAAyB,QAAQ,YAAY,CAAC;gBAC1D,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,KAAK,EAAE;wBACrB,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,cAAc,WAAW,KAAK;oBAChC;gBACF;YACF;YACA,mBAAmB;gBACjB,SAAS;gBACT,WAAW,CAAC;oBACV,MAAM,KAAK,QAAQ,YAAY,CAAC;oBAChC,OAAO,KAAK,SAAS,IAAI,MAAM;gBACjC;gBACA,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,iBAAiB,EAAE;wBACjC,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,4BAA4B,WAAW,iBAAiB;oBAC1D;gBACF;YACF;QACF;IACF;IAEA;QACE,OAAO;YACL;gBACE,KAAK;YACP;SACD;IACH;IAEA,YAAW,EACT,IAAI,EACJ,cAAc,EAIf;QACC,OAAO;YACL;YACA,IAAA,ySAAe,EACb;gBAAE,aAAa;YAAU,GACzB,IAAI,CAAC,OAAO,CAAC,cAAc,EAC3B;YAEF,CAAC,CAAC,EAAE,cAAc,CAAC,aAAa,IAAI,IAAI;SACzC;IACH;IAEA,YAAW,EAAE,IAAI,EAAiB;QAChC,OAAO,CAAC,CAAC,EAAE,KAAK,KAAK,CAAC,KAAK,EAAE;IAC/B;IAEA,wCAAwC;IACxC,GAAG,IAAA,kTAAwB,EAAC;QAC1B,UAAU;QACV,MAAM;QACN,aAAa;QACb,mBAAmB;YAAC;YAAM;YAAS;SAAoB;IACzD,EAAE;IAEF;QACE,OAAO;YACL,WAAW,IACT,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE;oBACzC,IAAI,YAAY;oBAChB,MAAM,EAAE,SAAS,EAAE,GAAG;oBACtB,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG;oBAE1B,IAAI,CAAC,OAAO;wBACV,OAAO;oBACT;oBAEA,MAAM,GAAG,CAAC,YAAY,CAAC,SAAS,GAAG,QAAQ,CAAC,MAAM;wBAChD,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI,EAAE;4BAChC,YAAY;4BACZ,GAAG,UAAU,CAAC,IAAI,KAAK,MAAM,KAAK,QAAQ;4BAC1C,OAAO;wBACT;oBACF;oBAEA,OAAO;gBACT;QACJ;IACF;AACF","debugId":null}},
    {"offset": {"line": 1034, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/tiptap/NoteMentionExtension.ts"],"sourcesContent":["import { createInlineMarkdownSpec, mergeAttributes } from '@tiptap/core';\nimport Mention from '@tiptap/extension-mention';\n\nexport interface NoteMentionNodeAttrs {\n  id: string;\n  label: string;\n  noteId: number;\n}\n\nexport const NoteMention = Mention.extend({\n  name: 'noteMention',\n\n  addAttributes() {\n    return {\n      id: {\n        default: null,\n        parseHTML: (element: HTMLElement) => element.getAttribute('data-id'),\n        renderHTML: (attributes: { id: string }) => {\n          if (!attributes.id) {\n            return {};\n          }\n          return {\n            'data-id': attributes.id,\n          };\n        },\n      },\n      label: {\n        default: null,\n        parseHTML: (element: HTMLElement) => element.getAttribute('data-label'),\n        renderHTML: (attributes: { label: string }) => {\n          if (!attributes.label) {\n            return {};\n          }\n          return {\n            'data-label': attributes.label,\n          };\n        },\n      },\n      noteId: {\n        default: null,\n        parseHTML: (element: HTMLElement) => {\n          const id = element.getAttribute('data-note-id');\n          return id ? parseInt(id, 10) : null;\n        },\n        renderHTML: (attributes: { noteId: number }) => {\n          if (!attributes.noteId) {\n            return {};\n          }\n          return {\n            'data-note-id': attributes.noteId,\n          };\n        },\n      },\n    };\n  },\n\n  parseHTML() {\n    return [\n      {\n        tag: 'span[data-type=\"noteMention\"]',\n      },\n    ];\n  },\n\n  renderHTML({\n    node,\n    HTMLAttributes,\n  }: {\n    node: Node;\n    HTMLAttributes: { [key: string]: string };\n  }) {\n    return [\n      'span',\n      mergeAttributes(\n        { 'data-type': 'noteMention' },\n        this.options.HTMLAttributes,\n        HTMLAttributes\n      ),\n      `#${HTMLAttributes['data-label'] || ''}`,\n    ];\n  },\n\n  renderText({ node }: { node: any }) {\n    return `#${node.attrs.label}`;\n  },\n\n  // Markdown support using Tiptap utility\n  ...createInlineMarkdownSpec({\n    nodeName: 'noteMention',\n    name: '#',\n    selfClosing: true,\n    allowedAttributes: ['id', 'label', 'noteId'],\n  }),\n\n  addKeyboardShortcuts() {\n    return {\n      Backspace: () =>\n        this.editor.commands.command(({ tr, state }) => {\n          let isNoteMention = false;\n          const { selection } = state;\n          const { empty, anchor } = selection;\n\n          if (!empty) {\n            return false;\n          }\n\n          state.doc.nodesBetween(anchor - 1, anchor, (node, pos) => {\n            if (node.type.name === this.name) {\n              isNoteMention = true;\n              tr.insertText('', pos, pos + node.nodeSize);\n              return false;\n            }\n          });\n\n          return isNoteMention;\n        }),\n    };\n  },\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQO,MAAM,cAAc,yaAAO,CAAC,MAAM,CAAC;IACxC,MAAM;IAEN;QACE,OAAO;YACL,IAAI;gBACF,SAAS;gBACT,WAAW,CAAC,UAAyB,QAAQ,YAAY,CAAC;gBAC1D,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,EAAE,EAAE;wBAClB,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,WAAW,WAAW,EAAE;oBAC1B;gBACF;YACF;YACA,OAAO;gBACL,SAAS;gBACT,WAAW,CAAC,UAAyB,QAAQ,YAAY,CAAC;gBAC1D,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,KAAK,EAAE;wBACrB,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,cAAc,WAAW,KAAK;oBAChC;gBACF;YACF;YACA,QAAQ;gBACN,SAAS;gBACT,WAAW,CAAC;oBACV,MAAM,KAAK,QAAQ,YAAY,CAAC;oBAChC,OAAO,KAAK,SAAS,IAAI,MAAM;gBACjC;gBACA,YAAY,CAAC;oBACX,IAAI,CAAC,WAAW,MAAM,EAAE;wBACtB,OAAO,CAAC;oBACV;oBACA,OAAO;wBACL,gBAAgB,WAAW,MAAM;oBACnC;gBACF;YACF;QACF;IACF;IAEA;QACE,OAAO;YACL;gBACE,KAAK;YACP;SACD;IACH;IAEA,YAAW,EACT,IAAI,EACJ,cAAc,EAIf;QACC,OAAO;YACL;YACA,IAAA,ySAAe,EACb;gBAAE,aAAa;YAAc,GAC7B,IAAI,CAAC,OAAO,CAAC,cAAc,EAC3B;YAEF,CAAC,CAAC,EAAE,cAAc,CAAC,aAAa,IAAI,IAAI;SACzC;IACH;IAEA,YAAW,EAAE,IAAI,EAAiB;QAChC,OAAO,CAAC,CAAC,EAAE,KAAK,KAAK,CAAC,KAAK,EAAE;IAC/B;IAEA,wCAAwC;IACxC,GAAG,IAAA,kTAAwB,EAAC;QAC1B,UAAU;QACV,MAAM;QACN,aAAa;QACb,mBAAmB;YAAC;YAAM;YAAS;SAAS;IAC9C,EAAE;IAEF;QACE,OAAO;YACL,WAAW,IACT,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE;oBACzC,IAAI,gBAAgB;oBACpB,MAAM,EAAE,SAAS,EAAE,GAAG;oBACtB,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG;oBAE1B,IAAI,CAAC,OAAO;wBACV,OAAO;oBACT;oBAEA,MAAM,GAAG,CAAC,YAAY,CAAC,SAAS,GAAG,QAAQ,CAAC,MAAM;wBAChD,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI,EAAE;4BAChC,gBAAgB;4BAChB,GAAG,UAAU,CAAC,IAAI,KAAK,MAAM,KAAK,QAAQ;4BAC1C,OAAO;wBACT;oBACF;oBAEA,OAAO;gBACT;QACJ;IACF;AACF","debugId":null}},
    {"offset": {"line": 1142, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/tiptap/MentionList.tsx"],"sourcesContent":["'use client';\n\nimport React, {\n  forwardRef,\n  useEffect,\n  useImperativeHandle,\n  useState,\n} from 'react';\nimport { WorkspaceMember } from '@/types/workspace';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport { User } from 'lucide-react';\n\nexport interface MentionListProps {\n  items: WorkspaceMember[];\n  command: (item: {\n    id: string;\n    label: string;\n    workspaceMemberId: number;\n  }) => void;\n}\n\nexport interface MentionListRef {\n  onKeyDown: (props: { event: KeyboardEvent }) => boolean;\n}\n\nexport const MentionList = forwardRef<MentionListRef, MentionListProps>(\n  (props, ref) => {\n    const [selectedIndex, setSelectedIndex] = useState(0);\n\n    const selectItem = (index: number) => {\n      const item = props.items[index];\n\n      if (item) {\n        props.command({\n          id: `member-${item.id}`,\n          label: item.user_profile?.name || 'Unknown',\n          workspaceMemberId: item.id,\n        });\n      }\n    };\n\n    const upHandler = () => {\n      setSelectedIndex(\n        (selectedIndex + props.items.length - 1) % props.items.length\n      );\n    };\n\n    const downHandler = () => {\n      setSelectedIndex((selectedIndex + 1) % props.items.length);\n    };\n\n    const enterHandler = () => {\n      selectItem(selectedIndex);\n    };\n\n    useEffect(() => setSelectedIndex(0), [props.items]);\n\n    useImperativeHandle(ref, () => ({\n      onKeyDown: ({ event }: { event: KeyboardEvent }) => {\n        if (event.key === 'ArrowUp') {\n          upHandler();\n          return true;\n        }\n\n        if (event.key === 'ArrowDown') {\n          downHandler();\n          return true;\n        }\n\n        if (event.key === 'Enter') {\n          enterHandler();\n          return true;\n        }\n\n        return false;\n      },\n    }));\n\n    return (\n      <div className='bg-white/10 backdrop-blur-xl border border-white/20 rounded-lg shadow-lg overflow-hidden max-h-[300px] overflow-y-auto'>\n        {props.items.length ? (\n          props.items.map((item, index) => (\n            <button\n              className={`flex items-center gap-3 w-full px-4 py-2.5 text-left transition-colors ${\n                index === selectedIndex ? 'bg-white/20' : 'hover:bg-white/10'\n              }`}\n              key={item.id}\n              onClick={() => selectItem(index)}\n              type='button'\n            >\n              <Avatar className='h-8 w-8 border border-white/20 bg-white/10'>\n                {item.user_profile?.avatar_url ? (\n                  <AvatarImage\n                    src={item.user_profile.avatar_url}\n                    alt={item.user_profile.name ?? 'Member'}\n                  />\n                ) : (\n                  <AvatarFallback>\n                    <User className='w-4 h-4 text-gray-300' />\n                  </AvatarFallback>\n                )}\n              </Avatar>\n              <div>\n                <div className='text-white font-medium'>\n                  {item.user_profile?.name || 'Unknown'}\n                </div>\n                <div className='text-xs text-gray-400 capitalize'>\n                  {item.role}\n                </div>\n              </div>\n            </button>\n          ))\n        ) : (\n          <div className='px-4 py-3 text-sm text-gray-400'>\n            No members found\n          </div>\n        )}\n      </div>\n    );\n  }\n);\n\nMentionList.displayName = 'MentionList';\n"],"names":[],"mappings":";;;;;AAEA;AAOA;AACA;AAVA;;;;;AAyBO,MAAM,4BAAc,IAAA,ucAAU,EACnC,CAAC,OAAO;IACN,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,qcAAQ,EAAC;IAEnD,MAAM,aAAa,CAAC;QAClB,MAAM,OAAO,MAAM,KAAK,CAAC,MAAM;QAE/B,IAAI,MAAM;YACR,MAAM,OAAO,CAAC;gBACZ,IAAI,CAAC,OAAO,EAAE,KAAK,EAAE,EAAE;gBACvB,OAAO,KAAK,YAAY,EAAE,QAAQ;gBAClC,mBAAmB,KAAK,EAAE;YAC5B;QACF;IACF;IAEA,MAAM,YAAY;QAChB,iBACE,CAAC,gBAAgB,MAAM,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,MAAM,KAAK,CAAC,MAAM;IAEjE;IAEA,MAAM,cAAc;QAClB,iBAAiB,CAAC,gBAAgB,CAAC,IAAI,MAAM,KAAK,CAAC,MAAM;IAC3D;IAEA,MAAM,eAAe;QACnB,WAAW;IACb;IAEA,IAAA,scAAS,EAAC,IAAM,iBAAiB,IAAI;QAAC,MAAM,KAAK;KAAC;IAElD,IAAA,gdAAmB,EAAC,KAAK,IAAM,CAAC;YAC9B,WAAW,CAAC,EAAE,KAAK,EAA4B;gBAC7C,IAAI,MAAM,GAAG,KAAK,WAAW;oBAC3B;oBACA,OAAO;gBACT;gBAEA,IAAI,MAAM,GAAG,KAAK,aAAa;oBAC7B;oBACA,OAAO;gBACT;gBAEA,IAAI,MAAM,GAAG,KAAK,SAAS;oBACzB;oBACA,OAAO;gBACT;gBAEA,OAAO;YACT;QACF,CAAC;IAED,qBACE,keAAC;QAAI,WAAU;kBACZ,MAAM,KAAK,CAAC,MAAM,GACjB,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,sBACrB,keAAC;gBACC,WAAW,CAAC,uEAAuE,EACjF,UAAU,gBAAgB,gBAAgB,qBAC1C;gBAEF,SAAS,IAAM,WAAW;gBAC1B,MAAK;;kCAEL,keAAC,iMAAM;wBAAC,WAAU;kCACf,KAAK,YAAY,EAAE,2BAClB,keAAC,sMAAW;4BACV,KAAK,KAAK,YAAY,CAAC,UAAU;4BACjC,KAAK,KAAK,YAAY,CAAC,IAAI,IAAI;;;;;qFAGjC,keAAC,yMAAc;sCACb,cAAA,keAAC,+PAAI;gCAAC,WAAU;;;;;;;;;;;;;;;;kCAItB,keAAC;;0CACC,keAAC;gCAAI,WAAU;0CACZ,KAAK,YAAY,EAAE,QAAQ;;;;;;0CAE9B,keAAC;gCAAI,WAAU;0CACZ,KAAK,IAAI;;;;;;;;;;;;;eArBT,KAAK,EAAE;;;;0EA2BhB,keAAC;YAAI,WAAU;sBAAkC;;;;;;;;;;;AAMzD;AAGF,YAAY,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 1278, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/tiptap/mentionSuggestion.ts"],"sourcesContent":["import { ReactRenderer } from '@tiptap/react';\nimport tippy, { Instance as TippyInstance } from 'tippy.js';\nimport { MentionList, MentionListRef } from '@/components/tiptap/MentionList';\nimport { WorkspaceMember } from '@/types/workspace';\nimport { SuggestionOptions, SuggestionProps } from '@tiptap/suggestion';\n\nexport const createMentionSuggestion = (\n  getMembersRef: () => WorkspaceMember[]\n): Omit<SuggestionOptions, 'editor'> => ({\n  items: ({ query }: { query: string }) => {\n    const members = getMembersRef();\n    return members\n      .filter(member => {\n        const name = member.user_profile?.name?.toLowerCase() || '';\n        return name.includes(query.toLowerCase());\n      })\n      .slice(0, 5);\n  },\n\n  render: () => {\n    let component: ReactRenderer<MentionListRef> | undefined;\n    let popup: TippyInstance[] | undefined;\n\n    return {\n      onStart: (props: SuggestionProps) => {\n        component = new ReactRenderer(MentionList, {\n          props,\n          editor: props.editor,\n        });\n\n        if (!props.clientRect) {\n          return;\n        }\n\n        popup = tippy('body', {\n          getReferenceClientRect: props.clientRect as () => DOMRect,\n          appendTo: () => document.body,\n          content: component.element,\n          showOnCreate: true,\n          interactive: true,\n          trigger: 'manual',\n          placement: 'bottom-start',\n        });\n      },\n\n      onUpdate(props: SuggestionProps) {\n        component?.updateProps(props);\n\n        if (!props.clientRect) {\n          return;\n        }\n\n        popup?.[0]?.setProps({\n          getReferenceClientRect: props.clientRect as () => DOMRect,\n        });\n      },\n\n      onKeyDown(props: { event: KeyboardEvent }) {\n        if (props.event.key === 'Escape') {\n          popup?.[0]?.hide();\n          return true;\n        }\n\n        return component?.ref?.onKeyDown(props) ?? false;\n      },\n\n      onExit() {\n        popup?.[0]?.destroy();\n        component?.destroy();\n      },\n    };\n  },\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAIO,MAAM,0BAA0B,CACrC,gBACsC,CAAC;QACvC,OAAO,CAAC,EAAE,KAAK,EAAqB;YAClC,MAAM,UAAU;YAChB,OAAO,QACJ,MAAM,CAAC,CAAA;gBACN,MAAM,OAAO,OAAO,YAAY,EAAE,MAAM,iBAAiB;gBACzD,OAAO,KAAK,QAAQ,CAAC,MAAM,WAAW;YACxC,GACC,KAAK,CAAC,GAAG;QACd;QAEA,QAAQ;YACN,IAAI;YACJ,IAAI;YAEJ,OAAO;gBACL,SAAS,CAAC;oBACR,YAAY,IAAI,mbAAa,CAAC,+MAAW,EAAE;wBACzC;wBACA,QAAQ,MAAM,MAAM;oBACtB;oBAEA,IAAI,CAAC,MAAM,UAAU,EAAE;wBACrB;oBACF;oBAEA,QAAQ,IAAA,4PAAK,EAAC,QAAQ;wBACpB,wBAAwB,MAAM,UAAU;wBACxC,UAAU,IAAM,SAAS,IAAI;wBAC7B,SAAS,UAAU,OAAO;wBAC1B,cAAc;wBACd,aAAa;wBACb,SAAS;wBACT,WAAW;oBACb;gBACF;gBAEA,UAAS,KAAsB;oBAC7B,WAAW,YAAY;oBAEvB,IAAI,CAAC,MAAM,UAAU,EAAE;wBACrB;oBACF;oBAEA,OAAO,CAAC,EAAE,EAAE,SAAS;wBACnB,wBAAwB,MAAM,UAAU;oBAC1C;gBACF;gBAEA,WAAU,KAA+B;oBACvC,IAAI,MAAM,KAAK,CAAC,GAAG,KAAK,UAAU;wBAChC,OAAO,CAAC,EAAE,EAAE;wBACZ,OAAO;oBACT;oBAEA,OAAO,WAAW,KAAK,UAAU,UAAU;gBAC7C;gBAEA;oBACE,OAAO,CAAC,EAAE,EAAE;oBACZ,WAAW;gBACb;YACF;QACF;IACF,CAAC","debugId":null}},
    {"offset": {"line": 1345, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/tiptap/NoteList.tsx"],"sourcesContent":["'use client';\n\nimport React, {\n  forwardRef,\n  useEffect,\n  useImperativeHandle,\n  useState,\n} from 'react';\nimport { NoteWithParsed } from '@/types/note';\nimport { FileText } from 'lucide-react';\n\nexport interface NoteListProps {\n  items: NoteWithParsed[];\n  command: (item: { id: string; label: string; noteId: number }) => void;\n}\n\nexport interface NoteListRef {\n  onKeyDown: (props: { event: KeyboardEvent }) => boolean;\n}\n\nexport const NoteList = forwardRef<NoteListRef, NoteListProps>((props, ref) => {\n  const [selectedIndex, setSelectedIndex] = useState(0);\n\n  const selectItem = (index: number) => {\n    const item = props.items[index];\n\n    if (item) {\n      props.command({\n        id: `note-${item.id}`,\n        label: item.title || 'Untitled',\n        noteId: item.id,\n      });\n    }\n  };\n\n  const upHandler = () => {\n    setSelectedIndex(\n      (selectedIndex + props.items.length - 1) % props.items.length\n    );\n  };\n\n  const downHandler = () => {\n    setSelectedIndex((selectedIndex + 1) % props.items.length);\n  };\n\n  const enterHandler = () => {\n    selectItem(selectedIndex);\n  };\n\n  useEffect(() => setSelectedIndex(0), [props.items]);\n\n  useImperativeHandle(ref, () => ({\n    onKeyDown: ({ event }: { event: KeyboardEvent }) => {\n      if (event.key === 'ArrowUp') {\n        upHandler();\n        return true;\n      }\n\n      if (event.key === 'ArrowDown') {\n        downHandler();\n        return true;\n      }\n\n      if (event.key === 'Enter') {\n        enterHandler();\n        return true;\n      }\n\n      return false;\n    },\n  }));\n\n  return (\n    <div className='bg-white/10 backdrop-blur-xl border border-white/20 rounded-lg shadow-lg overflow-hidden max-h-[300px] overflow-y-auto'>\n      {props.items.length ? (\n        props.items.map((item, index) => (\n          <button\n            className={`flex items-center gap-3 w-full px-4 py-2.5 text-left transition-colors ${\n              index === selectedIndex ? 'bg-white/20' : 'hover:bg-white/10'\n            }`}\n            key={item.id}\n            onClick={() => selectItem(index)}\n            type='button'\n          >\n            <div className='flex items-center justify-center w-8 h-8 rounded bg-green-500/20 border border-green-500/30'>\n              <FileText className='w-4 h-4 text-green-400' />\n            </div>\n            <div className='flex-1 min-w-0'>\n              <div className='text-white font-medium truncate'>\n                {item.title || 'Untitled'}\n              </div>\n              {item.content && (\n                <div className='text-xs text-gray-400 truncate'>\n                  {item.content.substring(0, 60)}\n                  {item.content.length > 60 ? '...' : ''}\n                </div>\n              )}\n            </div>\n          </button>\n        ))\n      ) : (\n        <div className='px-4 py-3 text-sm text-gray-400'>No notes found</div>\n      )}\n    </div>\n  );\n});\n\nNoteList.displayName = 'NoteList';\n"],"names":[],"mappings":";;;;;AAEA;AAOA;AATA;;;;AAoBO,MAAM,yBAAW,IAAA,ucAAU,EAA6B,CAAC,OAAO;IACrE,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,qcAAQ,EAAC;IAEnD,MAAM,aAAa,CAAC;QAClB,MAAM,OAAO,MAAM,KAAK,CAAC,MAAM;QAE/B,IAAI,MAAM;YACR,MAAM,OAAO,CAAC;gBACZ,IAAI,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE;gBACrB,OAAO,KAAK,KAAK,IAAI;gBACrB,QAAQ,KAAK,EAAE;YACjB;QACF;IACF;IAEA,MAAM,YAAY;QAChB,iBACE,CAAC,gBAAgB,MAAM,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,MAAM,KAAK,CAAC,MAAM;IAEjE;IAEA,MAAM,cAAc;QAClB,iBAAiB,CAAC,gBAAgB,CAAC,IAAI,MAAM,KAAK,CAAC,MAAM;IAC3D;IAEA,MAAM,eAAe;QACnB,WAAW;IACb;IAEA,IAAA,scAAS,EAAC,IAAM,iBAAiB,IAAI;QAAC,MAAM,KAAK;KAAC;IAElD,IAAA,gdAAmB,EAAC,KAAK,IAAM,CAAC;YAC9B,WAAW,CAAC,EAAE,KAAK,EAA4B;gBAC7C,IAAI,MAAM,GAAG,KAAK,WAAW;oBAC3B;oBACA,OAAO;gBACT;gBAEA,IAAI,MAAM,GAAG,KAAK,aAAa;oBAC7B;oBACA,OAAO;gBACT;gBAEA,IAAI,MAAM,GAAG,KAAK,SAAS;oBACzB;oBACA,OAAO;gBACT;gBAEA,OAAO;YACT;QACF,CAAC;IAED,qBACE,keAAC;QAAI,WAAU;kBACZ,MAAM,KAAK,CAAC,MAAM,GACjB,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,sBACrB,keAAC;gBACC,WAAW,CAAC,uEAAuE,EACjF,UAAU,gBAAgB,gBAAgB,qBAC1C;gBAEF,SAAS,IAAM,WAAW;gBAC1B,MAAK;;kCAEL,keAAC;wBAAI,WAAU;kCACb,cAAA,keAAC,+QAAQ;4BAAC,WAAU;;;;;;;;;;;kCAEtB,keAAC;wBAAI,WAAU;;0CACb,keAAC;gCAAI,WAAU;0CACZ,KAAK,KAAK,IAAI;;;;;;4BAEhB,KAAK,OAAO,kBACX,keAAC;gCAAI,WAAU;;oCACZ,KAAK,OAAO,CAAC,SAAS,CAAC,GAAG;oCAC1B,KAAK,OAAO,CAAC,MAAM,GAAG,KAAK,QAAQ;;;;;;;;;;;;;;eAdrC,KAAK,EAAE;;;;0EAqBhB,keAAC;YAAI,WAAU;sBAAkC;;;;;;;;;;;AAIzD;AAEA,SAAS,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 1470, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/tiptap/noteMentionSuggestion.ts"],"sourcesContent":["import { ReactRenderer } from '@tiptap/react';\nimport tippy, { Instance as TippyInstance } from 'tippy.js';\nimport { NoteList, NoteListRef } from '@/components/tiptap/NoteList';\nimport { NoteWithParsed } from '@/types/note';\nimport { SuggestionOptions, SuggestionProps } from '@tiptap/suggestion';\n\nexport const createNoteMentionSuggestion = (\n  getNotesRef: () => NoteWithParsed[]\n): Omit<SuggestionOptions, 'editor'> => ({\n  char: '#',\n  items: ({ query }: { query: string }) => {\n    const notes = getNotesRef();\n    return notes\n      .filter(note => {\n        const title = note.title?.toLowerCase() || '';\n        const content = note.content?.toLowerCase() || '';\n        const queryLower = query.toLowerCase();\n        return title.includes(queryLower) || content.includes(queryLower);\n      })\n      .slice(0, 5);\n  },\n\n  render: () => {\n    let component: ReactRenderer<NoteListRef> | undefined;\n    let popup: TippyInstance[] | undefined;\n\n    return {\n      onStart: (props: SuggestionProps) => {\n        component = new ReactRenderer(NoteList, {\n          props,\n          editor: props.editor,\n        });\n\n        if (!props.clientRect) {\n          return;\n        }\n\n        popup = tippy('body', {\n          getReferenceClientRect: props.clientRect as () => DOMRect,\n          appendTo: () => document.body,\n          content: component.element,\n          showOnCreate: true,\n          interactive: true,\n          trigger: 'manual',\n          placement: 'bottom-start',\n        });\n      },\n\n      onUpdate(props: SuggestionProps) {\n        component?.updateProps(props);\n\n        if (!props.clientRect) {\n          return;\n        }\n\n        popup?.[0]?.setProps({\n          getReferenceClientRect: props.clientRect as () => DOMRect,\n        });\n      },\n\n      onKeyDown(props: { event: KeyboardEvent }) {\n        if (props.event.key === 'Escape') {\n          popup?.[0]?.hide();\n          return true;\n        }\n\n        return component?.ref?.onKeyDown(props) ?? false;\n      },\n\n      onExit() {\n        popup?.[0]?.destroy();\n        component?.destroy();\n      },\n    };\n  },\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAIO,MAAM,8BAA8B,CACzC,cACsC,CAAC;QACvC,MAAM;QACN,OAAO,CAAC,EAAE,KAAK,EAAqB;YAClC,MAAM,QAAQ;YACd,OAAO,MACJ,MAAM,CAAC,CAAA;gBACN,MAAM,QAAQ,KAAK,KAAK,EAAE,iBAAiB;gBAC3C,MAAM,UAAU,KAAK,OAAO,EAAE,iBAAiB;gBAC/C,MAAM,aAAa,MAAM,WAAW;gBACpC,OAAO,MAAM,QAAQ,CAAC,eAAe,QAAQ,QAAQ,CAAC;YACxD,GACC,KAAK,CAAC,GAAG;QACd;QAEA,QAAQ;YACN,IAAI;YACJ,IAAI;YAEJ,OAAO;gBACL,SAAS,CAAC;oBACR,YAAY,IAAI,mbAAa,CAAC,yMAAQ,EAAE;wBACtC;wBACA,QAAQ,MAAM,MAAM;oBACtB;oBAEA,IAAI,CAAC,MAAM,UAAU,EAAE;wBACrB;oBACF;oBAEA,QAAQ,IAAA,4PAAK,EAAC,QAAQ;wBACpB,wBAAwB,MAAM,UAAU;wBACxC,UAAU,IAAM,SAAS,IAAI;wBAC7B,SAAS,UAAU,OAAO;wBAC1B,cAAc;wBACd,aAAa;wBACb,SAAS;wBACT,WAAW;oBACb;gBACF;gBAEA,UAAS,KAAsB;oBAC7B,WAAW,YAAY;oBAEvB,IAAI,CAAC,MAAM,UAAU,EAAE;wBACrB;oBACF;oBAEA,OAAO,CAAC,EAAE,EAAE,SAAS;wBACnB,wBAAwB,MAAM,UAAU;oBAC1C;gBACF;gBAEA,WAAU,KAA+B;oBACvC,IAAI,MAAM,KAAK,CAAC,GAAG,KAAK,UAAU;wBAChC,OAAO,CAAC,EAAE,EAAE;wBACZ,OAAO;oBACT;oBAEA,OAAO,WAAW,KAAK,UAAU,UAAU;gBAC7C;gBAEA;oBACE,OAAO,CAAC,EAAE,EAAE;oBACZ,WAAW;gBACb;YACF;QACF;IACF,CAAC","debugId":null}},
    {"offset": {"line": 1540, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/tiptap/extensions/useTiptapExtensions.ts"],"sourcesContent":["import { useRef, useMemo } from 'react';\nimport StarterKit from '@tiptap/starter-kit';\nimport { Markdown } from '@tiptap/markdown';\nimport Placeholder from '@tiptap/extension-placeholder';\nimport { CustomMention } from '@/lib/tiptap/MentionExtension';\nimport { NoteMention } from '@/lib/tiptap/NoteMentionExtension';\nimport { createMentionSuggestion } from '@/lib/tiptap/mentionSuggestion';\nimport { createNoteMentionSuggestion } from '@/lib/tiptap/noteMentionSuggestion';\nimport type { WorkspaceMember } from '@/types/workspace';\nimport type { Note, NoteWithParsed } from '@/types/note';\n\nexport type TiptapMode = 'full' | 'chat' | 'minimal' | 'readonly';\n\nexport interface UseTiptapExtensionsConfig {\n  mode: TiptapMode;\n  placeholder?: string;\n  enableMemberMentions?: boolean;\n  enableNoteMentions?: boolean;\n  workspaceMembers?: WorkspaceMember[];\n  workspaceNotes?: Note[] | NoteWithParsed[];\n}\n\n/**\n * Hook to get configured TipTap extensions based on use case\n */\nexport function useTiptapExtensions({\n  mode,\n  placeholder = 'Start typing...',\n  enableMemberMentions = false,\n  enableNoteMentions = false,\n  workspaceMembers = [],\n  workspaceNotes = [],\n}: UseTiptapExtensionsConfig): any[] {\n  // Use refs to avoid recreating suggestion components on every render\n  const membersRef = useRef<WorkspaceMember[]>([]);\n  const notesRef = useRef<Note[] | NoteWithParsed[]>([]);\n\n  // Update refs when data changes\n  membersRef.current = workspaceMembers;\n  notesRef.current = workspaceNotes;\n\n  // Memoize extensions - recreate when config or data changes\n  return useMemo(() => {\n    const extensions: any[] = [];\n\n    // Base extensions for all modes\n    if (mode === 'readonly' || mode === 'minimal') {\n      // Minimal set for display only\n      extensions.push(\n        StarterKit.configure({\n          heading: { levels: [1, 2, 3] },\n          code: false,\n        }),\n        Markdown\n      );\n    } else if (mode === 'chat') {\n      // Chat mode: basic formatting only (bold, italic, mentions)\n      extensions.push(\n        StarterKit.configure({\n          heading: false, // No headings in chat\n          blockquote: false, // No blockquotes in chat\n          codeBlock: false, // No code blocks in chat\n          horizontalRule: false, // No horizontal rules in chat\n          code: false,\n        }),\n        Placeholder.configure({ placeholder }),\n        Markdown\n      );\n    } else if (mode === 'full') {\n      // Full editor mode (for notes)\n      extensions.push(\n        StarterKit.configure({\n          heading: { levels: [1, 2, 3] },\n          code: false,\n        }),\n        Placeholder.configure({ placeholder }),\n        Markdown\n      );\n    }\n\n    // Add member mentions if enabled\n    if (enableMemberMentions) {\n      extensions.push(\n        CustomMention.configure({\n          HTMLAttributes: {\n            class: 'mention',\n          },\n          suggestion: createMentionSuggestion(() => membersRef.current),\n        })\n      );\n    }\n\n    // Add note mentions if enabled\n    if (enableNoteMentions) {\n      extensions.push(\n        NoteMention.configure({\n          HTMLAttributes: {\n            class: 'note-mention',\n          },\n          suggestion: createNoteMentionSuggestion(\n            () => notesRef.current as NoteWithParsed[]\n          ),\n        })\n      );\n    }\n\n    return extensions;\n  }, [mode, placeholder, enableMemberMentions, enableNoteMentions]);\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;AAkBO,SAAS,oBAAoB,EAClC,IAAI,EACJ,cAAc,iBAAiB,EAC/B,uBAAuB,KAAK,EAC5B,qBAAqB,KAAK,EAC1B,mBAAmB,EAAE,EACrB,iBAAiB,EAAE,EACO;IAC1B,qEAAqE;IACrE,MAAM,aAAa,IAAA,mcAAM,EAAoB,EAAE;IAC/C,MAAM,WAAW,IAAA,mcAAM,EAA4B,EAAE;IAErD,gCAAgC;IAChC,WAAW,OAAO,GAAG;IACrB,SAAS,OAAO,GAAG;IAEnB,4DAA4D;IAC5D,OAAO,IAAA,ocAAO,EAAC;QACb,MAAM,aAAoB,EAAE;QAE5B,gCAAgC;QAChC,IAAI,SAAS,cAAc,SAAS,WAAW;YAC7C,+BAA+B;YAC/B,WAAW,IAAI,CACb,oRAAU,CAAC,SAAS,CAAC;gBACnB,SAAS;oBAAE,QAAQ;wBAAC;wBAAG;wBAAG;qBAAE;gBAAC;gBAC7B,MAAM;YACR,IACA,gXAAQ;QAEZ,OAAO,IAAI,SAAS,QAAQ;YAC1B,4DAA4D;YAC5D,WAAW,IAAI,CACb,oRAAU,CAAC,SAAS,CAAC;gBACnB,SAAS;gBACT,YAAY;gBACZ,WAAW;gBACX,gBAAgB;gBAChB,MAAM;YACR,IACA,ycAAW,CAAC,SAAS,CAAC;gBAAE;YAAY,IACpC,gXAAQ;QAEZ,OAAO,IAAI,SAAS,QAAQ;YAC1B,+BAA+B;YAC/B,WAAW,IAAI,CACb,oRAAU,CAAC,SAAS,CAAC;gBACnB,SAAS;oBAAE,QAAQ;wBAAC;wBAAG;wBAAG;qBAAE;gBAAC;gBAC7B,MAAM;YACR,IACA,ycAAW,CAAC,SAAS,CAAC;gBAAE;YAAY,IACpC,gXAAQ;QAEZ;QAEA,iCAAiC;QACjC,IAAI,sBAAsB;YACxB,WAAW,IAAI,CACb,8MAAa,CAAC,SAAS,CAAC;gBACtB,gBAAgB;oBACd,OAAO;gBACT;gBACA,YAAY,IAAA,yNAAuB,EAAC,IAAM,WAAW,OAAO;YAC9D;QAEJ;QAEA,+BAA+B;QAC/B,IAAI,oBAAoB;YACtB,WAAW,IAAI,CACb,gNAAW,CAAC,SAAS,CAAC;gBACpB,gBAAgB;oBACd,OAAO;gBACT;gBACA,YAAY,IAAA,iOAA2B,EACrC,IAAM,SAAS,OAAO;YAE1B;QAEJ;QAEA,OAAO;IACT,GAAG;QAAC;QAAM;QAAa;QAAsB;KAAmB;AAClE","debugId":null}},
    {"offset": {"line": 1639, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/tiptap/extractMentions.ts"],"sourcesContent":["import type { Editor } from '@tiptap/core';\n\n/**\n * Extract workspace member IDs from mention nodes in the editor\n */\nexport function extractMemberMentions(editor: Editor | null): number[] {\n  if (!editor) return [];\n\n  const mentionedIds: number[] = [];\n  editor.state.doc.descendants(node => {\n    if (node.type.name === 'mention' && node.attrs.workspaceMemberId) {\n      mentionedIds.push(node.attrs.workspaceMemberId);\n    }\n  });\n\n  return [...new Set(mentionedIds)]; // Remove duplicates\n}\n\n/**\n * Extract note IDs from note mention nodes in the editor\n */\nexport function extractNoteMentions(editor: Editor | null): number[] {\n  if (!editor) return [];\n\n  const mentionedNoteIds: number[] = [];\n  editor.state.doc.descendants(node => {\n    if (node.type.name === 'noteMention' && node.attrs.noteId) {\n      mentionedNoteIds.push(node.attrs.noteId);\n    }\n  });\n\n  return [...new Set(mentionedNoteIds)]; // Remove duplicates\n}\n"],"names":[],"mappings":";;;;;;AAKO,SAAS,sBAAsB,MAAqB;IACzD,IAAI,CAAC,QAAQ,OAAO,EAAE;IAEtB,MAAM,eAAyB,EAAE;IACjC,OAAO,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,CAAA;QAC3B,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,aAAa,KAAK,KAAK,CAAC,iBAAiB,EAAE;YAChE,aAAa,IAAI,CAAC,KAAK,KAAK,CAAC,iBAAiB;QAChD;IACF;IAEA,OAAO;WAAI,IAAI,IAAI;KAAc,EAAE,oBAAoB;AACzD;AAKO,SAAS,oBAAoB,MAAqB;IACvD,IAAI,CAAC,QAAQ,OAAO,EAAE;IAEtB,MAAM,mBAA6B,EAAE;IACrC,OAAO,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,CAAA;QAC3B,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,iBAAiB,KAAK,KAAK,CAAC,MAAM,EAAE;YACzD,iBAAiB,IAAI,CAAC,KAAK,KAAK,CAAC,MAAM;QACzC;IACF;IAEA,OAAO;WAAI,IAAI,IAAI;KAAkB,EAAE,oBAAoB;AAC7D","debugId":null}},
    {"offset": {"line": 1673, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/TiptapChatInput.tsx"],"sourcesContent":["'use client';\n\nimport {\n  useRef,\n  useState,\n  useEffect,\n  useImperativeHandle,\n  forwardRef,\n  useCallback,\n} from 'react';\nimport { useEditor, EditorContent } from '@tiptap/react';\nimport { ArrowUp, Square } from 'lucide-react';\nimport { VoiceInputButton } from './VoiceInputButton';\nimport { useUI } from '@/contexts/UIContext';\nimport { useTiptapExtensions } from '@/components/tiptap/extensions/useTiptapExtensions';\nimport {\n  extractMemberMentions,\n  extractNoteMentions,\n} from '@/lib/tiptap/extractMentions';\nimport type { WorkspaceMember } from '@/types/workspace';\nimport type { Note } from '@/types/note';\n\ninterface TiptapChatInputProps {\n  onSend: (\n    text: string,\n    mentionedMemberIds: number[],\n    mentionedNoteIds: number[]\n  ) => void | Promise<void>;\n  onStop?: () => void;\n  isLoading?: boolean;\n  placeholder?: string;\n  canStop?: boolean;\n  isUploading?: boolean;\n  hasAttachments?: boolean;\n  workspaceMembers?: WorkspaceMember[];\n  workspaceNotes?: Note[];\n}\n\nexport type TiptapChatInputRef = {\n  focus: () => void;\n  clearContent: () => void;\n};\n\nconst TiptapChatInput = forwardRef<TiptapChatInputRef, TiptapChatInputProps>(\n  function TiptapChatInput(\n    {\n      onSend,\n      onStop,\n      isLoading = false,\n      placeholder = 'メッセージを入力...',\n      canStop = true,\n      isUploading = false,\n      hasAttachments = false,\n      workspaceMembers = [],\n      workspaceNotes = [],\n    },\n    ref\n  ) {\n    const [isFocused, setIsFocused] = useState(false);\n    const [isEmpty, setIsEmpty] = useState(true);\n    const { setInputActive } = useUI();\n    const editorRef = useRef<HTMLDivElement>(null);\n\n    // Get extensions for chat mode with member mentions and note mentions\n    const extensions = useTiptapExtensions({\n      mode: 'chat',\n      placeholder,\n      enableMemberMentions: workspaceMembers.length > 0,\n      enableNoteMentions: workspaceNotes.length > 0,\n      workspaceMembers,\n      workspaceNotes,\n    });\n\n    // Initialize TipTap editor\n    // Pass extensions as dependency to recreate editor when they change\n    const editor = useEditor(\n      {\n        immediatelyRender: false,\n        extensions,\n        content: '',\n        contentType: 'markdown',\n        editorProps: {\n          attributes: {\n            class:\n              'w-full bg-transparent text-white px-5 py-3.5 pr-[140px] focus:outline-none resize-none overflow-y-auto chat-input-editor',\n            style: 'max-height: 140px;', // ~7 lines\n          },\n        },\n        onUpdate: ({ editor }) => {\n          const text = editor.getText();\n          setIsEmpty(text.trim().length === 0);\n        },\n        onFocus: () => setIsFocused(true),\n        onBlur: () => setIsFocused(false),\n      },\n      [extensions]\n    );\n\n    useImperativeHandle(ref, () => ({\n      focus: () => {\n        editor?.commands.focus();\n      },\n      clearContent: () => {\n        editor?.commands.clearContent();\n        setIsEmpty(true);\n      },\n    }));\n\n    // Update input active state\n    useEffect(() => {\n      setInputActive(isFocused || !isEmpty);\n    }, [isFocused, isEmpty, setInputActive]);\n\n    const handleSend = useCallback(async () => {\n      if (isLoading || isUploading || !editor) return;\n\n      const text = editor.getMarkdown().trim();\n      const hasText = text.length > 0;\n\n      if (!hasText && !hasAttachments) return;\n\n      // Extract mentions before clearing\n      const mentionedMemberIds = extractMemberMentions(editor);\n      const mentionedNoteIds = extractNoteMentions(editor);\n\n      await onSend(text || '', mentionedMemberIds, mentionedNoteIds);\n\n      // Clear editor content\n      editor.commands.clearContent();\n      setIsEmpty(true);\n    }, [isLoading, isUploading, editor, hasAttachments, onSend]);\n\n    const handleStop = () => {\n      if (onStop && isLoading) {\n        onStop();\n      }\n    };\n\n    // Handle voice input\n    const handleVoiceTranscript = (text: string) => {\n      if (editor) {\n        editor.commands.setContent(text);\n        editor.commands.focus();\n      }\n    };\n\n    // Add keyboard shortcuts\n    useEffect(() => {\n      if (!editor) return;\n\n      const handleKeyDown = (event: Event) => {\n        const keyboardEvent = event as KeyboardEvent;\n\n        // Shift+Enter: newline (default behavior)\n        if (keyboardEvent.key === 'Enter' && keyboardEvent.shiftKey) {\n          return;\n        }\n\n        // Enter (without Shift): send message\n        if (keyboardEvent.key === 'Enter' && !keyboardEvent.shiftKey) {\n          // Don't send during IME composition\n          if (keyboardEvent.isComposing) {\n            return;\n          }\n\n          keyboardEvent.preventDefault();\n          handleSend();\n        }\n      };\n\n      const editorElement = editorRef.current?.querySelector('.ProseMirror');\n      editorElement?.addEventListener('keydown', handleKeyDown);\n\n      return () => {\n        editorElement?.removeEventListener('keydown', handleKeyDown);\n      };\n    }, [editor, handleSend]);\n\n    if (!editor) {\n      return null;\n    }\n\n    return (\n      <div className='flex-1 relative ml-[55px]'>\n        <div\n          ref={editorRef}\n          className='w-full bg-white/8 backdrop-blur-xl rounded-4xl border border-black focus-within:shadow-[0_12px_40px_rgba(0,0,0,0.25),inset_0_1px_0_rgba(255,255,255,0.18)] transition-all duration-300 shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)]'\n        >\n          <EditorContent editor={editor} />\n        </div>\n\n        {/* マイクボタン - 送信ボタンの左 */}\n        <div className='absolute right-[50px] bottom-1.5 z-10'>\n          <VoiceInputButton\n            onTranscriptChange={handleVoiceTranscript}\n            currentText={editor.getText()}\n            disabled={isLoading}\n            className='w-11 h-11 rounded-full bg-transparent border-0 text-white hover:scale-102 transition-all duration-300'\n          />\n        </div>\n\n        {/* 送信ボタン / 停止ボタン */}\n        <button\n          onClick={isLoading && canStop ? handleStop : handleSend}\n          disabled={isLoading || isUploading || (isEmpty && !hasAttachments)}\n          className='absolute right-2.5 bottom-1.5 w-10 h-10 rounded-full bg-white/10 backdrop-blur-xl border border-black text-white flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed hover:bg-white/15 hover:scale-102 transition-all duration-300 shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)] hover:shadow-[0_12px_40px_rgba(0,0,0,0.25),inset_0_1px_0_rgba(255,255,255,0.18)]'\n        >\n          {isLoading && canStop ? (\n            <Square className='w-4 h-4 fill-current' />\n          ) : (\n            <ArrowUp className='w-4 h-4' />\n          )}\n        </button>\n      </div>\n    );\n  }\n);\n\nexport default TiptapChatInput;\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1879, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/FileUploadMenu.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef, useState } from 'react';\nimport { Image as ImageIcon, File as FileIcon } from 'lucide-react';\n\ntype FileUploadMenuProps = {\n  onFilesSelected: (files: File[]) => void;\n  maxFiles?: number;\n  disabled?: boolean;\n};\n\nexport default function FileUploadMenu({\n  onFilesSelected,\n  maxFiles = 4,\n  disabled = false,\n}: FileUploadMenuProps) {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const imageInputRef = useRef<HTMLInputElement>(null);\n  const [isOpen, setIsOpen] = useState(false);\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n\n    if (files.length === 0) return;\n\n    // Limit to maxFiles\n    const selectedFiles = files.slice(0, maxFiles);\n\n    // Validate file count\n    if (files.length > maxFiles) {\n      alert(`You can only upload up to ${maxFiles} files at once.`);\n    }\n\n    onFilesSelected(selectedFiles);\n\n    // Reset input\n    e.target.value = '';\n  };\n\n  const triggerFileInput = (accept: 'image' | 'file') => {\n    const input = accept === 'image' ? imageInputRef : fileInputRef;\n    input.current?.click();\n  };\n\n  useEffect(() => {\n    if (disabled) {\n      setIsOpen(false);\n    }\n  }, [disabled]);\n\n  return (\n    <div className='relative flex flex-col items-center gap-3'>\n      {isOpen && (\n        <div className='absolute bottom-full mb-3 flex flex-col items-center gap-2 bg-white/8 backdrop-blur-xl text-white/80 rounded-full border border-black shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)] px-3 py-4'>\n          <button\n            type='button'\n            onClick={() => triggerFileInput('image')}\n            disabled={disabled}\n            className='relative group flex h-8 w-8 items-center justify-center rounded-full bg-white/5 text-white/80 transition-all duration-300 hover:bg-white/15 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed'\n            aria-label='Upload images'\n          >\n            <ImageIcon className='h-4 w-4' />\n            <span className='pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-md bg-black/80 px-2 py-1 text-xs text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100'>\n              Upload images\n            </span>\n          </button>\n          <button\n            type='button'\n            onClick={() => triggerFileInput('file')}\n            disabled={disabled}\n            className='relative group flex h-8 w-8 items-center justify-center rounded-full bg-white/5 text-white/80 transition-all duration-300 hover:bg-white/15 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed'\n            aria-label='Upload files'\n          >\n            <FileIcon className='h-4 w-4' />\n            <span className='pointer-events-none absolute left-full ml-2 whitespace-nowrap rounded-md bg-black/80 px-2 py-1 text-xs text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100'>\n              Upload files\n            </span>\n          </button>\n        </div>\n      )}\n      <button\n        type='button'\n        onClick={() => {\n          if (disabled) return;\n          setIsOpen(prev => !prev);\n        }}\n        disabled={disabled}\n        className='flex h-[52px] w-[52px] items-center justify-center rounded-full bg-white/8 backdrop-blur-xl text-white/80 border border-black transition-all duration-300 shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)] hover:bg-white/15 hover:text-white hover:shadow-[0_12px_40px_rgba(0,0,0,0.25),inset_0_1px_0_rgba(255,255,255,0.18)] disabled:opacity-50 disabled:cursor-not-allowed'\n        aria-label='Add files'\n      >\n        <svg\n          xmlns='http://www.w3.org/2000/svg'\n          width='20'\n          height='20'\n          viewBox='0 0 24 24'\n          fill='none'\n          stroke='currentColor'\n          strokeWidth='2'\n          strokeLinecap='round'\n          strokeLinejoin='round'\n        >\n          <line x1='12' y1='5' x2='12' y2='19'></line>\n          <line x1='5' y1='12' x2='19' y2='12'></line>\n        </svg>\n      </button>\n\n      {/* Hidden file inputs */}\n      <input\n        ref={imageInputRef}\n        type='file'\n        accept='image/*'\n        multiple\n        className='hidden'\n        onChange={handleFileSelect}\n      />\n      <input\n        ref={fileInputRef}\n        type='file'\n        multiple\n        className='hidden'\n        onChange={handleFileSelect}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAHA;;;;AAWe,SAAS,eAAe,EACrC,eAAe,EACf,WAAW,CAAC,EACZ,WAAW,KAAK,EACI;IACpB,MAAM,eAAe,IAAA,mcAAM,EAAmB;IAC9C,MAAM,gBAAgB,IAAA,mcAAM,EAAmB;IAC/C,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,qcAAQ,EAAC;IAErC,MAAM,mBAAmB,CAAC;QACxB,MAAM,QAAQ,MAAM,IAAI,CAAC,EAAE,MAAM,CAAC,KAAK,IAAI,EAAE;QAE7C,IAAI,MAAM,MAAM,KAAK,GAAG;QAExB,oBAAoB;QACpB,MAAM,gBAAgB,MAAM,KAAK,CAAC,GAAG;QAErC,sBAAsB;QACtB,IAAI,MAAM,MAAM,GAAG,UAAU;YAC3B,MAAM,CAAC,0BAA0B,EAAE,SAAS,eAAe,CAAC;QAC9D;QAEA,gBAAgB;QAEhB,cAAc;QACd,EAAE,MAAM,CAAC,KAAK,GAAG;IACnB;IAEA,MAAM,mBAAmB,CAAC;QACxB,MAAM,QAAQ,WAAW,UAAU,gBAAgB;QACnD,MAAM,OAAO,EAAE;IACjB;IAEA,IAAA,scAAS,EAAC;QACR,IAAI,UAAU;YACZ,UAAU;QACZ;IACF,GAAG;QAAC;KAAS;IAEb,qBACE,keAAC;QAAI,WAAU;;YACZ,wBACC,keAAC;gBAAI,WAAU;;kCACb,keAAC;wBACC,MAAK;wBACL,SAAS,IAAM,iBAAiB;wBAChC,UAAU;wBACV,WAAU;wBACV,cAAW;;0CAEX,keAAC,kQAAS;gCAAC,WAAU;;;;;;0CACrB,keAAC;gCAAK,WAAU;0CAAsL;;;;;;;;;;;;kCAIxM,keAAC;wBACC,MAAK;wBACL,SAAS,IAAM,iBAAiB;wBAChC,UAAU;wBACV,WAAU;wBACV,cAAW;;0CAEX,keAAC,+PAAQ;gCAAC,WAAU;;;;;;0CACpB,keAAC;gCAAK,WAAU;0CAAsL;;;;;;;;;;;;;;;;;;0BAM5M,keAAC;gBACC,MAAK;gBACL,SAAS;oBACP,IAAI,UAAU;oBACd,UAAU,CAAA,OAAQ,CAAC;gBACrB;gBACA,UAAU;gBACV,WAAU;gBACV,cAAW;0BAEX,cAAA,keAAC;oBACC,OAAM;oBACN,OAAM;oBACN,QAAO;oBACP,SAAQ;oBACR,MAAK;oBACL,QAAO;oBACP,aAAY;oBACZ,eAAc;oBACd,gBAAe;;sCAEf,keAAC;4BAAK,IAAG;4BAAK,IAAG;4BAAI,IAAG;4BAAK,IAAG;;;;;;sCAChC,keAAC;4BAAK,IAAG;4BAAI,IAAG;4BAAK,IAAG;4BAAK,IAAG;;;;;;;;;;;;;;;;;0BAKpC,keAAC;gBACC,KAAK;gBACL,MAAK;gBACL,QAAO;gBACP,QAAQ;gBACR,WAAU;gBACV,UAAU;;;;;;0BAEZ,keAAC;gBACC,KAAK;gBACL,MAAK;gBACL,QAAQ;gBACR,WAAU;gBACV,UAAU;;;;;;;;;;;;AAIlB","debugId":null}},
    {"offset": {"line": 2072, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/FileUploadPreview.tsx"],"sourcesContent":["'use client';\n\nimport Image from 'next/image';\nimport { X, File as FileIcon, Loader2 } from 'lucide-react';\nimport { type UploadedFile } from '@/lib/api/workspaceFilesApi';\n\nexport interface FileUploadItem {\n  file: File;\n  id: string;\n  preview?: string;\n  uploaded?: UploadedFile;\n  error?: string;\n  uploading: boolean;\n  progress: number;\n}\n\ntype FileUploadPreviewProps = {\n  files: FileUploadItem[];\n  workspaceId: number;\n  onRemove: (id: string) => void;\n  onUploadComplete: (id: string, uploadedFile: UploadedFile) => void;\n  onUploadError: (id: string, error: string) => void;\n};\n\nexport default function FileUploadPreview(props: FileUploadPreviewProps) {\n  const { files, onRemove } = props;\n\n  if (files.length === 0) return null;\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];\n  };\n\n  const isImage = (mimeType: string): boolean => {\n    return mimeType.startsWith('image/');\n  };\n\n  return (\n    <div className='px-2 md:px-6 pb-2'>\n      <div className='flex flex-wrap gap-2'>\n        {files.map(item => {\n          const isImg = isImage(item.file.type);\n          const hasError = !!item.error;\n          const isUploading = item.uploading;\n          const isComplete = !!item.uploaded;\n\n          return (\n            <div\n              key={item.id}\n              className='relative group bg-white/8 backdrop-blur-xl border border-black rounded-xl overflow-hidden shadow-[0_8px_32px_rgba(0,0,0,0.15),inset_0_1px_0_rgba(255,255,255,0.12)]'\n            >\n              {/* Remove button */}\n              {!isUploading && (\n                <button\n                  type='button'\n                  onClick={() => onRemove(item.id)}\n                  className='absolute top-1 right-1 z-10 w-6 h-6 rounded-full bg-black/60 hover:bg-black/80 backdrop-blur-sm flex items-center justify-center transition-all opacity-0 group-hover:opacity-100'\n                  aria-label='Remove file'\n                >\n                  <X className='w-3 h-3 text-white' />\n                </button>\n              )}\n\n              {/* Preview */}\n              <div className='w-20 h-20 relative'>\n                {isImg && item.preview ? (\n                  <Image\n                    src={item.preview}\n                    alt={item.file.name}\n                    fill\n                    sizes='80px'\n                    className='object-cover'\n                    unoptimized\n                  />\n                ) : (\n                  <div className='w-full h-full flex items-center justify-center bg-white/5'>\n                    <FileIcon className='w-8 h-8 text-white/40' />\n                  </div>\n                )}\n\n                {/* Upload progress overlay */}\n                {isUploading && (\n                  <div className='absolute inset-0 bg-black/50 flex items-center justify-center'>\n                    <Loader2 className='w-5 h-5 text-white animate-spin' />\n                  </div>\n                )}\n\n                {/* Error overlay */}\n                {hasError && (\n                  <div className='absolute inset-0 bg-red-900/50 flex items-center justify-center'>\n                    <X className='w-5 h-5 text-red-200' />\n                  </div>\n                )}\n\n                {/* Success indicator */}\n                {isComplete && (\n                  <div className='absolute inset-0 bg-green-900/30 flex items-center justify-center'>\n                    <div className='w-3 h-3 rounded-full bg-green-500' />\n                  </div>\n                )}\n\n                {/* Progress bar */}\n                {isUploading && (\n                  <div className='absolute bottom-0 left-0 right-0 h-1 bg-black/30'>\n                    <div\n                      className='h-full bg-white/60 transition-all duration-300'\n                      style={{ width: `${item.progress}%` }}\n                    />\n                  </div>\n                )}\n              </div>\n\n              {/* File name */}\n              <div className='px-2 py-1 max-w-[80px]'>\n                <p\n                  className='text-xs text-white/80 truncate'\n                  title={item.file.name}\n                >\n                  {item.file.name}\n                </p>\n                <p className='text-xs text-white/40'>\n                  {formatFileSize(item.file.size)}\n                </p>\n              </div>\n\n              {/* Error message */}\n              {hasError && (\n                <div className='px-2 pb-1'>\n                  <p\n                    className='text-xs text-red-300 truncate'\n                    title={item.error}\n                  >\n                    {item.error}\n                  </p>\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAAA;AAHA;;;;AAwBe,SAAS,kBAAkB,KAA6B;IACrE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG;IAE5B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAE/B,MAAM,iBAAiB,CAAC;QACtB,IAAI,UAAU,GAAG,OAAO;QACxB,MAAM,IAAI;QACV,MAAM,QAAQ;YAAC;YAAS;YAAM;YAAM;SAAK;QACzC,MAAM,IAAI,KAAK,KAAK,CAAC,KAAK,GAAG,CAAC,SAAS,KAAK,GAAG,CAAC;QAChD,OAAO,KAAK,KAAK,CAAC,AAAC,QAAQ,KAAK,GAAG,CAAC,GAAG,KAAM,OAAO,MAAM,MAAM,KAAK,CAAC,EAAE;IAC1E;IAEA,MAAM,UAAU,CAAC;QACf,OAAO,SAAS,UAAU,CAAC;IAC7B;IAEA,qBACE,keAAC;QAAI,WAAU;kBACb,cAAA,keAAC;YAAI,WAAU;sBACZ,MAAM,GAAG,CAAC,CAAA;gBACT,MAAM,QAAQ,QAAQ,KAAK,IAAI,CAAC,IAAI;gBACpC,MAAM,WAAW,CAAC,CAAC,KAAK,KAAK;gBAC7B,MAAM,cAAc,KAAK,SAAS;gBAClC,MAAM,aAAa,CAAC,CAAC,KAAK,QAAQ;gBAElC,qBACE,keAAC;oBAEC,WAAU;;wBAGT,CAAC,6BACA,keAAC;4BACC,MAAK;4BACL,SAAS,IAAM,SAAS,KAAK,EAAE;4BAC/B,WAAU;4BACV,cAAW;sCAEX,cAAA,keAAC,sPAAC;gCAAC,WAAU;;;;;;;;;;;sCAKjB,keAAC;4BAAI,WAAU;;gCACZ,SAAS,KAAK,OAAO,iBACpB,keAAC,4XAAK;oCACJ,KAAK,KAAK,OAAO;oCACjB,KAAK,KAAK,IAAI,CAAC,IAAI;oCACnB,IAAI;oCACJ,OAAM;oCACN,WAAU;oCACV,WAAW;;;;;yDAGb,keAAC;oCAAI,WAAU;8CACb,cAAA,keAAC,+PAAQ;wCAAC,WAAU;;;;;;;;;;;gCAKvB,6BACC,keAAC;oCAAI,WAAU;8CACb,cAAA,keAAC,iRAAO;wCAAC,WAAU;;;;;;;;;;;gCAKtB,0BACC,keAAC;oCAAI,WAAU;8CACb,cAAA,keAAC,sPAAC;wCAAC,WAAU;;;;;;;;;;;gCAKhB,4BACC,keAAC;oCAAI,WAAU;8CACb,cAAA,keAAC;wCAAI,WAAU;;;;;;;;;;;gCAKlB,6BACC,keAAC;oCAAI,WAAU;8CACb,cAAA,keAAC;wCACC,WAAU;wCACV,OAAO;4CAAE,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;wCAAC;;;;;;;;;;;;;;;;;sCAO5C,keAAC;4BAAI,WAAU;;8CACb,keAAC;oCACC,WAAU;oCACV,OAAO,KAAK,IAAI,CAAC,IAAI;8CAEpB,KAAK,IAAI,CAAC,IAAI;;;;;;8CAEjB,keAAC;oCAAE,WAAU;8CACV,eAAe,KAAK,IAAI,CAAC,IAAI;;;;;;;;;;;;wBAKjC,0BACC,keAAC;4BAAI,WAAU;sCACb,cAAA,keAAC;gCACC,WAAU;gCACV,OAAO,KAAK,KAAK;0CAEhB,KAAK,KAAK;;;;;;;;;;;;mBApFZ,KAAK,EAAE;;;;;YA0FlB;;;;;;;;;;;AAIR","debugId":null}},
    {"offset": {"line": 2289, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/lib/api/workspaceFilesApi.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/browserClient';\n\nconst supabase = createClient();\nconst WORKSPACE_FILES_BUCKET = 'workspace-files';\n\nexport interface WorkspaceFile {\n  id: number; // bigint (database primary key)\n  original_filename: string;\n  file_path: string;\n  file_size: number;\n  mime_type: string;\n  created_at: string;\n}\n\nexport interface UploadedFile {\n  id: number; // workspace_file_id (bigint, database primary key)\n  file_path: string;\n  url: string;\n  original_filename: string;\n  file_size: number;\n  mime_type: string;\n}\n\n/**\n * Upload a file to workspace storage\n */\nexport async function uploadWorkspaceFile(\n  workspaceId: number,\n  file: File\n): Promise<UploadedFile> {\n  // Generate a UUID for the storage path (not the database ID)\n  const storageUuid = crypto.randomUUID();\n  const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');\n\n  // Storage path: workspace-files/{workspace_id}/uploads/{uuid}/{original_filename}\n  const filePath = `${workspaceId}/uploads/${storageUuid}/${sanitizedFilename}`;\n\n  // Upload to Supabase Storage\n  const { error: uploadError } = await supabase.storage\n    .from(WORKSPACE_FILES_BUCKET)\n    .upload(filePath, file, {\n      cacheControl: '3600',\n      upsert: false,\n    });\n\n  if (uploadError) throw uploadError;\n\n  // Insert file metadata into workspace_files table (database ID is auto-generated bigint)\n  const { data: fileData, error: dbError } = await supabase\n    .from('workspace_files')\n    .insert({\n      orginal_file_name: file.name, // Note: schema has typo \"orginal\" instead of \"original\"\n      file_path: filePath,\n      mime_type: file.type,\n      file_size: file.size,\n      workspace_id: workspaceId,\n    })\n    .select()\n    .single();\n\n  if (dbError) throw dbError;\n\n  // Generate signed URL for private bucket (valid for 1 hour)\n  const { data: signedUrlData, error: signedUrlError } = await supabase.storage\n    .from(WORKSPACE_FILES_BUCKET)\n    .createSignedUrl(filePath, 3600); // 1 hour expiration\n\n  if (signedUrlError) {\n    console.warn('Error creating signed URL:', signedUrlError);\n  }\n\n  // Return file info with workspace_file_id\n  return {\n    id: fileData.id,\n    file_path: filePath,\n    url: signedUrlData?.signedUrl || '', // Signed URL for private bucket\n    original_filename: file.name,\n    file_size: file.size,\n    mime_type: file.type,\n  };\n}\n\n/**\n * Get signed file URL from workspace_file_id (bigint)\n * For private buckets, returns a signed URL valid for the specified duration\n */\nexport async function getFileUrl(\n  workspaceFileId: number,\n  expiresIn: number = 3600\n): Promise<string | null> {\n  const { data, error } = await supabase\n    .from('workspace_files')\n    .select('file_path')\n    .eq('id', workspaceFileId)\n    .single();\n\n  if (error || !data) {\n    console.warn('File not found in database:', error);\n    return null;\n  }\n\n  // Create signed URL for private bucket\n  const { data: signedUrlData, error: signedUrlError } = await supabase.storage\n    .from(WORKSPACE_FILES_BUCKET)\n    .createSignedUrl(data.file_path, expiresIn);\n\n  if (signedUrlError || !signedUrlData) {\n    console.warn('Error creating signed URL:', signedUrlError);\n    return null;\n  }\n\n  return signedUrlData.signedUrl;\n}\n\n/**\n * Link files to a message\n */\nexport async function linkFilesToMessage(\n  messageId: number,\n  workspaceFileIds: number[]\n): Promise<void> {\n  if (workspaceFileIds.length === 0) return;\n\n  const rows = workspaceFileIds.map(workspaceFileId => ({\n    message_id: messageId,\n    workspace_file_id: workspaceFileId,\n  }));\n\n  const { error } = await supabase.from('workspace_message_files').insert(rows);\n\n  if (error) throw error;\n}\n\n/**\n * Get all files for a workspace\n */\nexport async function getWorkspaceFiles(\n  workspaceId: number,\n  limit: number = 50\n): Promise<WorkspaceFile[]> {\n  const { data, error } = await supabase\n    .from('workspace_files')\n    .select(\n      'id, orginal_file_name, file_path, file_size, mime_type, created_at'\n    )\n    .eq('workspace_id', workspaceId)\n    .order('created_at', { ascending: false })\n    .limit(limit);\n\n  if (error) throw error;\n\n  // Map the typo field name to correct one\n  return (data || []).map(file => ({\n    id: file.id,\n    original_filename: file.orginal_file_name,\n    file_path: file.file_path,\n    file_size: file.file_size,\n    mime_type: file.mime_type,\n    created_at: file.created_at,\n  }));\n}\n\n/**\n * Delete a workspace file\n */\nexport async function deleteWorkspaceFile(\n  workspaceFileId: number\n): Promise<void> {\n  // First, get the file path from the database\n  const { data: fileData, error: fetchError } = await supabase\n    .from('workspace_files')\n    .select('file_path')\n    .eq('id', workspaceFileId)\n    .single();\n\n  if (fetchError) {\n    console.warn('Error fetching file for deletion:', fetchError);\n  }\n\n  // Delete from storage if we have the path\n  if (fileData?.file_path) {\n    const { error: storageError } = await supabase.storage\n      .from(WORKSPACE_FILES_BUCKET)\n      .remove([fileData.file_path]);\n\n    if (storageError) {\n      console.warn('Error deleting file from storage:', storageError);\n    }\n  }\n\n  // Delete from workspace_files table (CASCADE will handle workspace_message_files)\n  const { error: dbError } = await supabase\n    .from('workspace_files')\n    .delete()\n    .eq('id', workspaceFileId);\n\n  if (dbError) {\n    console.warn('Error deleting file from database:', dbError);\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2404, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/ReplyIndicator.tsx"],"sourcesContent":["export const ReplyIndicator = ({\n  replyingTo,\n  onCancelReply,\n}: {\n  replyingTo: { id: number; text: string; authorName?: string };\n  onCancelReply?: () => void;\n}) => {\n  return (\n    <div className='flex items-center justify-between bg-white/8 backdrop-blur-xl border border-black rounded-2xl px-4 py-2 shadow-[0_8px_32px_rgba(0,0,0,0.25),inset_0_1px_0_rgba(255,255,255,0.18)]'>\n      <div className='flex-1 min-w-0'>\n        <p className='text-xs text-white/60 mb-1'>\n          Replying to {replyingTo.authorName || 'message'}\n        </p>\n        <p className='text-xs text-white/40 truncate'>\n          {replyingTo.text.slice(0, 100)}\n          {replyingTo.text.length > 100 ? '...' : ''}\n        </p>\n      </div>\n      {onCancelReply && (\n        <button\n          onClick={onCancelReply}\n          className='ml-3 text-white/60 hover:text-white/80 transition-colors text-sm'\n        >\n          ✕\n        </button>\n      )}\n    </div>\n  );\n};\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,iBAAiB,CAAC,EAC7B,UAAU,EACV,aAAa,EAId;IACC,qBACE,keAAC;QAAI,WAAU;;0BACb,keAAC;gBAAI,WAAU;;kCACb,keAAC;wBAAE,WAAU;;4BAA6B;4BAC3B,WAAW,UAAU,IAAI;;;;;;;kCAExC,keAAC;wBAAE,WAAU;;4BACV,WAAW,IAAI,CAAC,KAAK,CAAC,GAAG;4BACzB,WAAW,IAAI,CAAC,MAAM,GAAG,MAAM,QAAQ;;;;;;;;;;;;;YAG3C,+BACC,keAAC;gBACC,SAAS;gBACT,WAAU;0BACX;;;;;;;;;;;;AAMT","debugId":null}},
    {"offset": {"line": 2465, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/components/chat-input/ChatInput.tsx"],"sourcesContent":["'use client';\n\nimport TiptapChatInput from './TiptapChatInput';\nimport {\n  useEffect,\n  useRef,\n  useImperativeHandle,\n  forwardRef,\n  useState,\n  useCallback,\n} from 'react';\nimport FileUploadMenu from './FileUploadMenu';\nimport FileUploadPreview, { type FileUploadItem } from './FileUploadPreview';\nimport {\n  uploadWorkspaceFile,\n  type UploadedFile,\n} from '@/lib/api/workspaceFilesApi';\nimport { ReplyIndicator } from './ReplyIndicator';\nimport type { WorkspaceMember } from '@/types/workspace';\nimport type { Note } from '@/types/note';\n\ntype ChatInputProps = {\n  onSend: (\n    content: string,\n    workspaceFileIds?: number[],\n    mentionedMemberIds?: number[],\n    mentionedNoteIds?: number[]\n  ) => void;\n  onStop?: () => void;\n  isLoading?: boolean;\n  placeholder?: string;\n  canStop?: boolean;\n  replyingTo?: { id: number; text: string; authorName?: string } | null;\n  onCancelReply?: () => void;\n  workspaceId?: number;\n  workspaceMembers?: WorkspaceMember[];\n  workspaceNotes?: Note[];\n};\n\nexport type ChatInputRef = {\n  focus: () => void;\n  clearContent: () => void;\n};\n\nconst ChatInput = forwardRef<ChatInputRef, ChatInputProps>(function ChatInput(\n  {\n    onSend,\n    onStop,\n    isLoading = false,\n    placeholder = 'Ask anything',\n    canStop = true,\n    replyingTo,\n    onCancelReply,\n    workspaceId,\n    workspaceMembers = [],\n    workspaceNotes = [],\n  },\n  ref\n) {\n  const inputRef = useRef<{\n    focus: () => void;\n    clearContent: () => void;\n  } | null>(null);\n  const [uploadItems, setUploadItems] = useState<FileUploadItem[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n\n  const hasAttachments = uploadItems.length > 0;\n\n  useImperativeHandle(ref, () => ({\n    focus: () => {\n      inputRef.current?.focus();\n    },\n    clearContent: () => {\n      inputRef.current?.clearContent();\n    },\n  }));\n\n  // Focus input when replying\n  useEffect(() => {\n    if (replyingTo) {\n      // Small delay to ensure DOM is ready\n      setTimeout(() => {\n        inputRef.current?.focus();\n      }, 100);\n    }\n  }, [replyingTo]);\n\n  const handleFilesSelected = useCallback(\n    (files: File[]) => {\n      if (!workspaceId) return;\n\n      const newItems: FileUploadItem[] = files.map(file => {\n        const id = `${Date.now()}-${Math.random()}`;\n        const isImage = file.type.startsWith('image/');\n        let preview: string | undefined;\n\n        if (isImage) {\n          preview = URL.createObjectURL(file);\n        }\n\n        return {\n          file,\n          id,\n          preview,\n          uploading: false,\n          progress: 0,\n        };\n      });\n\n      setUploadItems(prev => {\n        const combined = [...prev, ...newItems];\n        // Limit to 4 files\n        return combined.slice(0, 4);\n      });\n    },\n    [workspaceId]\n  );\n\n  const handleRemoveFile = useCallback((id: string) => {\n    setUploadItems(prev => {\n      const item = prev.find(entry => entry.id === id);\n      if (item?.preview) {\n        URL.revokeObjectURL(item.preview);\n      }\n      return prev.filter(entry => entry.id !== id);\n    });\n  }, []);\n\n  const handleUploadComplete = useCallback(\n    (id: string, uploadedFile: UploadedFile) => {\n      setUploadItems(prev =>\n        prev.map(item =>\n          item.id === id ? { ...item, uploaded: uploadedFile } : item\n        )\n      );\n    },\n    []\n  );\n\n  const handleUploadError = useCallback((id: string, error: string) => {\n    setUploadItems(prev =>\n      prev.map(item =>\n        item.id === id ? { ...item, error, uploading: false } : item\n      )\n    );\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      uploadItems.forEach(item => {\n        if (item.preview) {\n          URL.revokeObjectURL(item.preview);\n        }\n      });\n    };\n  }, [uploadItems]);\n\n  const handleSend = useCallback(\n    async (\n      content: string,\n      mentionedMemberIds?: number[],\n      mentionedNoteIds?: number[]\n    ) => {\n      if (isLoading || isUploading) return;\n\n      // Allow sending if there's text or files\n      const trimmed = content.trim();\n      const hasText = trimmed.length > 0;\n\n      if (!hasText && uploadItems.length === 0) return;\n\n      let workspaceFileIds: number[] = [];\n\n      if (uploadItems.length > 0 && workspaceId) {\n        setIsUploading(true);\n        try {\n          const uploadPromises = uploadItems.map(async item => {\n            if (item.uploaded) {\n              return item.uploaded.id;\n            }\n\n            const uploaded = await uploadWorkspaceFile(workspaceId, item.file);\n            return uploaded.id;\n          });\n\n          workspaceFileIds = await Promise.all(uploadPromises);\n        } catch (error) {\n          console.error('Error uploading files:', error);\n          alert('Failed to upload files. Please try again.');\n          setIsUploading(false);\n          return;\n        }\n        setIsUploading(false);\n      }\n\n      onSend(\n        trimmed || '',\n        workspaceFileIds.length ? workspaceFileIds : undefined,\n        mentionedMemberIds,\n        mentionedNoteIds\n      );\n\n      setUploadItems(prev => {\n        prev.forEach(item => {\n          if (item.preview) {\n            URL.revokeObjectURL(item.preview);\n          }\n        });\n        return [];\n      });\n    },\n    [isLoading, isUploading, onSend, uploadItems, workspaceId]\n  );\n\n  return (\n    <div className='bg-gradient-to-br from-slate-950 via-black to-slate-950 relative z-10 rounded-t-3xl'>\n      {/* Reply indicator - absolutely positioned above input */}\n      {replyingTo && (\n        <div className='absolute bottom-full left-0 right-0 px-4 md:px-8 pb-2 pointer-events-auto'>\n          <ReplyIndicator\n            replyingTo={replyingTo}\n            onCancelReply={onCancelReply}\n          />\n        </div>\n      )}\n      {/* File Upload Preview */}\n      {workspaceId && uploadItems.length > 0 && (\n        <FileUploadPreview\n          files={uploadItems}\n          workspaceId={workspaceId}\n          onRemove={handleRemoveFile}\n          onUploadComplete={handleUploadComplete}\n          onUploadError={handleUploadError}\n        />\n      )}\n      {/* 入力UI */}\n      <div className='px-2 md:px-6 pt-2'>\n        <div className='w-full md:max-w-4xl md:mx-auto'>\n          <div className='relative'>\n            {/* File Upload Menu - Plus button */}\n            {workspaceId && (\n              <div className='absolute left-0 z-10'>\n                <FileUploadMenu\n                  onFilesSelected={handleFilesSelected}\n                  maxFiles={4}\n                  disabled={isLoading || isUploading || uploadItems.length >= 4}\n                />\n              </div>\n            )}\n            <TiptapChatInput\n              ref={inputRef}\n              placeholder={placeholder}\n              onSend={handleSend}\n              onStop={onStop}\n              isLoading={isLoading}\n              canStop={canStop}\n              isUploading={isUploading}\n              hasAttachments={hasAttachments}\n              workspaceMembers={workspaceMembers}\n              workspaceNotes={workspaceNotes}\n            />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n});\n\nexport default ChatInput;\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2707, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/features/notifications/components/NotificationPanel.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef } from 'react';\nimport { useUI } from '@/contexts/UIContext';\nimport { useThreadContext } from '@/contexts/ThreadContext';\nimport { createClient } from '@/lib/supabase/browserClient';\nimport {\n  getPastDueNotifications,\n  markMultipleNotificationsAsSent,\n  updateNotificationStatus,\n} from '@/lib/api/notificationsApi';\nimport type { Notification, NotificationStatus } from '@/types/notification';\n\n// propsでsendMessageを受け取る\ntype NotificationPanelProps = {\n  sendMessage: (content: string, notificationId?: number) => Promise<void>;\n};\n\nexport default function NotificationPanel({\n  sendMessage,\n}: NotificationPanelProps) {\n  const { isNotificationPanelOpen, closeNotificationPanel } = useUI();\n  const { selectedThreadId } = useThreadContext();\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [userId, setUserId] = useState<string | null>(null);\n  const panelRef = useRef<HTMLDivElement>(null);\n\n  // Get userId\n  useEffect(() => {\n    const getUserId = async () => {\n      const supabase = createClient();\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      if (user) {\n        setUserId(user.id);\n      }\n    };\n    getUserId();\n  }, []);\n\n  // Load notifications when panel opens\n  useEffect(() => {\n    if (isNotificationPanelOpen && userId) {\n      loadNotifications();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isNotificationPanelOpen, userId]);\n\n  // Handle click outside\n  useEffect(() => {\n    if (!isNotificationPanelOpen) return;\n\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as HTMLElement;\n\n      // Ignore clicks on the notification trigger button\n      if (target.closest('[data-notification-trigger=\"true\"]')) {\n        return;\n      }\n\n      // Close if clicked outside the panel\n      if (panelRef.current && !panelRef.current.contains(target)) {\n        closeNotificationPanel();\n      }\n    };\n\n    // Add slight delay to prevent immediate closing\n    setTimeout(() => {\n      document.addEventListener('mousedown', handleClickOutside);\n    }, 100);\n\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [isNotificationPanelOpen, closeNotificationPanel]);\n\n  const loadNotifications = async () => {\n    if (!userId) return;\n\n    try {\n      setLoading(true);\n      const fetchedNotifications = await getPastDueNotifications(userId);\n      const uniqueByTask = dedupeByTask(fetchedNotifications);\n      setNotifications(uniqueByTask);\n\n      // Mark scheduled notifications as sent\n      const scheduledIds = uniqueByTask\n        .filter(\n          n => n.status === 'scheduled' && new Date(n.due_date) < new Date()\n        )\n        .map(n => n.id);\n\n      if (scheduledIds.length > 0) {\n        const updatedNotifications =\n          await markMultipleNotificationsAsSent(scheduledIds);\n        setNotifications(prev => {\n          const merged = prev.map(notification => {\n            const updated = updatedNotifications.find(\n              u => u.id === notification.id\n            );\n            return updated || notification;\n          });\n          return dedupeByTask(merged);\n        });\n      }\n    } catch (error) {\n      console.error('Failed to load notifications:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatDate = (dateString: string): string => {\n    const date = new Date(dateString);\n    return date.toLocaleDateString('en-US', {\n      month: 'short',\n      day: 'numeric',\n      hour: 'numeric',\n      minute: '2-digit',\n    });\n  };\n\n  const handleNotificationClick = async (notificationId: number) => {\n    if (!selectedThreadId) {\n      console.error('No thread selected');\n      return;\n    }\n\n    try {\n      // 1. パネルを即座に閉じる\n      closeNotificationPanel();\n\n      // 2. HomePageのsendMessageを使って通知メッセージを送信（同じインスタンス）\n      await sendMessage('', notificationId);\n\n      // 3. 通知をresolvedに更新\n      await updateNotificationStatus(\n        notificationId,\n        'resolved' as NotificationStatus\n      );\n    } catch (error) {\n      console.error('Failed to trigger notification:', error);\n    }\n  };\n\n  function dedupeByTask(notifications: Notification[]): Notification[] {\n    const lookup = notifications.reduce<Record<number, Notification>>(\n      (acc, notification) => {\n        const existing = acc[notification.task_id];\n        if (!existing) {\n          acc[notification.task_id] = notification;\n          return acc;\n        }\n\n        const existingTime = new Date(existing.due_date).getTime();\n        const currentTime = new Date(notification.due_date).getTime();\n\n        if (currentTime >= existingTime) {\n          acc[notification.task_id] = notification;\n        }\n\n        return acc;\n      },\n      {}\n    );\n\n    return Object.values(lookup);\n  }\n  return (\n    <div\n      ref={panelRef}\n      className={`fixed right-4 w-94 max-h-100 bg-black/30 backdrop-blur-sm border border-black/10 rounded-2xl shadow-2xl transition-all duration-300 ease-in-out z-50 ${\n        isNotificationPanelOpen\n          ? 'opacity-100 translate-y-0'\n          : 'opacity-0 -translate-y-4 pointer-events-none'\n      }`}\n    >\n      {/* Content */}\n      <div className='overflow-y-auto max-h-100 p-3'>\n        {loading ? (\n          <div className='flex justify-center items-center py-8'>\n            <div className='animate-spin rounded-full h-6 w-6 border-b-2 border-black'></div>\n          </div>\n        ) : notifications.length === 0 ? (\n          <div className='text-center py-8'>\n            <div className='text-white/40 text-sm mb-2'>通知はありません</div>\n            <div className='text-white/30 text-xs'>\n              新しい通知があるとここに表示されます\n            </div>\n          </div>\n        ) : (\n          <div className='space-y-2'>\n            {notifications.map(notification => (\n              <div\n                key={notification.id}\n                className='p-3 rounded-2xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5 cursor-pointer'\n                onClick={() => handleNotificationClick(notification.id)}\n              >\n                <div className='flex items-start justify-between gap-2'>\n                  <h4 className='text-sm text-white/90 font-medium flex-1 line-clamp-2'>\n                    {notification.title}\n                  </h4>\n                  {notification.status === 'scheduled' && (\n                    <span className='text-[10px] px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300 border border-blue-500/30 whitespace-nowrap'>\n                      NEW\n                    </span>\n                  )}\n                </div>\n                <div className='text-[11px] text-white/40 mt-1'>\n                  {formatDate(notification.due_date)}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2950, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/hooks/useCogno.ts"],"sourcesContent":["'use client';\n\nimport { useState, useCallback, useEffect, useRef } from 'react';\nimport { Message } from '@/types/chat';\n\nconst API_BASE_URL =\n  process.env.NEXT_PUBLIC_API_BASE_URL || 'http://0.0.0.0:8000';\n\nexport function useCogno(threadId: number | null) {\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  // メッセージ一覧取得（初回読み込み用）\n  const fetchMessages = useCallback(async (tid: number) => {\n    try {\n      setError(null);\n      const response = await fetch(\n        `${API_BASE_URL}/api/cogno/threads/${tid}/messages`\n      );\n      if (!response.ok) throw new Error('Failed to fetch messages');\n      const data = await response.json();\n      setMessages(data.messages || []);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to fetch messages');\n      console.error('Error fetching messages:', err);\n    }\n  }, []);\n\n  // threadIdが変更されたら自動的にメッセージを取得\n  useEffect(() => {\n    if (threadId) {\n      fetchMessages(threadId);\n    } else {\n      // threadIdがnullの場合はメッセージをクリア\n      setMessages([]);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [threadId]); // fetchMessagesはuseCallbackで固定されているため依存配列から除外\n\n  // ストリーム停止関数\n  const stopStream = useCallback(() => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      abortControllerRef.current = null;\n      setIsLoading(false);\n    }\n  }, []);\n\n  // 統合されたメッセージ送信関数（通常メッセージと通知メッセージの両方を処理）\n  const sendMessage = useCallback(\n    async (\n      content: string,\n      notificationId?: number,\n      timerCompleted?: boolean\n    ) => {\n      if (!threadId) return;\n\n      // 既存のストリームがあれば中断\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n\n      // 新しいAbortControllerを作成\n      const abortController = new AbortController();\n      abortControllerRef.current = abortController;\n\n      setIsLoading(true);\n      setError(null);\n\n      // ユーザーメッセージを追加（通知の場合はスキップ）\n      let tempUserMsg: Message | null = null;\n      if (content.trim()) {\n        tempUserMsg = {\n          id: Date.now().toString(),\n          content,\n          role: 'user',\n        };\n      }\n\n      // AIメッセージを追加\n      const tempAIMsg: Message = {\n        id: (Date.now() + (tempUserMsg ? 1 : 0)).toString(),\n        content: '',\n        role: 'assistant',\n      };\n\n      // メッセージを追加\n      if (tempUserMsg) {\n        setMessages(prev => [...prev, tempUserMsg!, tempAIMsg]);\n      } else {\n        setMessages(prev => [...prev, tempAIMsg]);\n      }\n\n      try {\n        const response = await fetch(\n          `${API_BASE_URL}/api/cogno/conversations/stream`,\n          {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              thread_id: threadId,\n              message: content,\n              ...(notificationId && { notification_id: notificationId }),\n              ...(timerCompleted && { timer_completed: true }),\n            }),\n            signal: abortController.signal,\n          }\n        );\n\n        if (!response.ok) throw new Error('Failed to send message');\n\n        const reader = response.body?.getReader();\n        const decoder = new TextDecoder();\n\n        if (!reader) throw new Error('Response body is null');\n\n        let accumulatedContent = '';\n        let buffer = '';\n        let lastUpdateTime = 0;\n        const UPDATE_THROTTLE = 50; // 50msごとに更新\n\n        while (true) {\n          // 中断された場合はループを抜ける\n          if (abortController.signal.aborted) {\n            break;\n          }\n\n          const { done, value } = await reader.read();\n          if (done) break;\n\n          const chunk = decoder.decode(value, { stream: true });\n          buffer += chunk;\n\n          const lines = buffer.split('\\n');\n          buffer = lines.pop() || '';\n\n          for (const line of lines) {\n            if (line.startsWith('data: ')) {\n              const data = line.slice(6);\n              if (data === '[DONE]') continue;\n              const parsedData = JSON.parse(data);\n              accumulatedContent += parsedData.data;\n\n              // スロットリング: 最後の更新から50ms経過した場合のみ更新\n              const now = Date.now();\n              if (now - lastUpdateTime >= UPDATE_THROTTLE) {\n                // ストリーム中の仮AIメッセージを更新\n                setMessages(prev =>\n                  prev.map(msg =>\n                    msg.id === tempAIMsg.id\n                      ? { ...msg, content: accumulatedContent }\n                      : msg\n                  )\n                );\n                lastUpdateTime = now;\n              }\n            }\n          }\n        }\n\n        // ループ終了後、最後の更新を確実に反映\n        setMessages(prev =>\n          prev.map(msg =>\n            msg.id === tempAIMsg.id\n              ? { ...msg, content: accumulatedContent }\n              : msg\n          )\n        );\n\n        // 中断された場合は仮メッセージを削除せず、そのまま残す\n        if (abortController.signal.aborted) {\n          console.log('Stream aborted by user');\n          return;\n        }\n\n        // ★重要: Stream完了後、DB保存済みの確定メッセージを取得\n        // これでmeta.timer付きの確定メッセージに置き換わる\n        await fetchMessages(threadId);\n        console.log(\n          'Stream completed. Fetched saved messages with meta.timer.'\n        );\n      } catch (err) {\n        // AbortErrorの場合はユーザーが中断したのでエラーとして扱わない\n        if (err instanceof Error && err.name === 'AbortError') {\n          console.log('Stream aborted by user');\n          return;\n        }\n\n        const errorMessage =\n          err instanceof Error ? err.message : 'An error occurred';\n        setError(errorMessage);\n        console.error('Error in sendMessage:', err);\n\n        // エラー時は仮メッセージを削除\n        setMessages(prev =>\n          prev.filter(\n            msg => msg.id !== tempUserMsg?.id && msg.id !== tempAIMsg.id\n          )\n        );\n      } finally {\n        setIsLoading(false);\n        abortControllerRef.current = null;\n      }\n    },\n    [threadId, fetchMessages]\n  );\n\n  // タイマー開始（手動開始用 - 通常は使われない）\n  const startTimer = useCallback(\n    async (durationMinutes: number) => {\n      if (!threadId) return;\n\n      try {\n        const response = await fetch(`${API_BASE_URL}/api/cogno/timers/start`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            thread_id: threadId,\n            duration_minutes: durationMinutes,\n          }),\n        });\n\n        if (!response.ok) throw new Error('Failed to start timer');\n\n        // Pollingが自動的にタイマーメッセージを検出\n        console.log(\n          'Timer started manually. Polling will detect the timer message.'\n        );\n      } catch (err) {\n        console.error('Error starting timer:', err);\n        setError(err instanceof Error ? err.message : 'Failed to start timer');\n      }\n    },\n    [threadId]\n  );\n\n  return {\n    messages,\n    sendMessage,\n    fetchMessages,\n    isLoading,\n    error,\n    startTimer,\n    stopStream,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3165, "column": 0}, "map": {"version":3,"sources":["file:///Users/air13/code/cogni/cogni-frontend/apps/web/src/app/%28private%29/home/page.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\nimport ChatContainer from '@/features/cogno/components/ChatContainer';\nimport ChatInput from '@/components/chat-input/ChatInput';\nimport NotificationPanel from '@/features/notifications/components/NotificationPanel';\nimport { useCogno } from '@/hooks/useCogno';\nimport { useThreadContext } from '@/contexts/ThreadContext';\nimport { useThreads } from '@/hooks/useThreads';\nimport { useUI } from '@/contexts/UIContext';\nimport { useCopilotReadable } from '@copilotkit/react-core';\n\nexport default function HomePage() {\n  const { selectedThreadId, setSelectedThreadId } = useThreadContext();\n  const { threads, loading: threadsLoading, createThread } = useThreads();\n  const { messages, sendMessage, isLoading, error, stopStream } =\n    useCogno(selectedThreadId);\n  const { isThreadSidebarOpen } = useUI();\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\n  const prevMessageCountRef = useRef(0);\n  const hasInitialized = useRef(false);\n\n  useCopilotReadable({\n    description: 'cogni chat history',\n    value: messages\n      .slice(-5)\n      .map(message => message.content)\n      .join('\\n'),\n    categories: ['cogni_chat'],\n  });\n\n  // スレッドの自動選択と初回スレッド作成（1つのuseEffectに統合）\n  useEffect(() => {\n    if (threadsLoading || hasInitialized.current) return;\n\n    // スレッドが0件の場合：初回スレッドを作成\n    if (threads.length === 0) {\n      hasInitialized.current = true;\n      const now = new Date();\n      const dateTimeTitle = now.toLocaleString('en-US', {\n        month: 'short',\n        day: 'numeric',\n        year: 'numeric',\n        hour: 'numeric',\n        minute: '2-digit',\n        hour12: true,\n      });\n      createThread(dateTimeTitle)\n        .then(newThread => setSelectedThreadId(newThread.id))\n        .catch(err => {\n          console.error('Failed to create initial thread:', err);\n          hasInitialized.current = false;\n        });\n      return;\n    }\n\n    // スレッドが存在し、選択されていない場合：最新のスレッドを選択\n    if (threads.length > 0 && selectedThreadId === null) {\n      hasInitialized.current = true;\n      setSelectedThreadId(threads[0].id);\n      return;\n    }\n\n    // 既に選択されている場合は初期化済みとする\n    if (selectedThreadId !== null) {\n      hasInitialized.current = true;\n    }\n  }, [\n    threads,\n    threadsLoading,\n    selectedThreadId,\n    setSelectedThreadId,\n    createThread,\n  ]);\n\n  // 新しいメッセージが追加されたら自動スクロール\n  useEffect(() => {\n    const currentCount = messages.length;\n\n    if (\n      currentCount > prevMessageCountRef.current &&\n      currentCount > 0 &&\n      scrollContainerRef.current\n    ) {\n      setTimeout(() => {\n        scrollContainerRef.current?.scrollTo({\n          top: scrollContainerRef.current.scrollHeight,\n          behavior: 'smooth',\n        });\n      }, 100);\n    }\n\n    prevMessageCountRef.current = currentCount;\n  }, [messages]);\n\n  return (\n    <div\n      className={`flex flex-col h-full transition-all duration-300 ${\n        isThreadSidebarOpen\n          ? 'translate-x-[240px] md:translate-x-0 md:ml-80'\n          : 'translate-x-0'\n      }`}\n    >\n      <ChatContainer\n        ref={scrollContainerRef}\n        messages={messages}\n        sendMessage={sendMessage}\n      />\n      <ChatInput\n        onSend={(content: string) => {\n          // Wrapper to match InputArea's expected signature\n          void sendMessage(content);\n        }}\n        onStop={stopStream}\n        isLoading={isLoading}\n      />\n      {/* NotificationPanelにsendMessageを渡す */}\n      <NotificationPanel sendMessage={sendMessage} />\n      {error && <div className='text-red-500 text-center p-4'>{error}</div>}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA;;;;;;;;;;;AAYe,SAAS;IACtB,MAAM,EAAE,gBAAgB,EAAE,mBAAmB,EAAE,GAAG,IAAA,0MAAgB;IAClE,MAAM,EAAE,OAAO,EAAE,SAAS,cAAc,EAAE,YAAY,EAAE,GAAG,IAAA,6LAAU;IACrE,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,SAAS,EAAE,KAAK,EAAE,UAAU,EAAE,GAC3D,IAAA,yLAAQ,EAAC;IACX,MAAM,EAAE,mBAAmB,EAAE,GAAG,IAAA,2LAAK;IACrC,MAAM,qBAAqB,IAAA,mcAAM,EAAiB;IAClD,MAAM,sBAAsB,IAAA,mcAAM,EAAC;IACnC,MAAM,iBAAiB,IAAA,mcAAM,EAAC;IAE9B,IAAA,2bAAkB,EAAC;QACjB,aAAa;QACb,OAAO,SACJ,KAAK,CAAC,CAAC,GACP,GAAG,CAAC,CAAA,UAAW,QAAQ,OAAO,EAC9B,IAAI,CAAC;QACR,YAAY;YAAC;SAAa;IAC5B;IAEA,sCAAsC;IACtC,IAAA,scAAS,EAAC;QACR,IAAI,kBAAkB,eAAe,OAAO,EAAE;QAE9C,uBAAuB;QACvB,IAAI,QAAQ,MAAM,KAAK,GAAG;YACxB,eAAe,OAAO,GAAG;YACzB,MAAM,MAAM,IAAI;YAChB,MAAM,gBAAgB,IAAI,cAAc,CAAC,SAAS;gBAChD,OAAO;gBACP,KAAK;gBACL,MAAM;gBACN,MAAM;gBACN,QAAQ;gBACR,QAAQ;YACV;YACA,aAAa,eACV,IAAI,CAAC,CAAA,YAAa,oBAAoB,UAAU,EAAE,GAClD,KAAK,CAAC,CAAA;gBACL,QAAQ,KAAK,CAAC,oCAAoC;gBAClD,eAAe,OAAO,GAAG;YAC3B;YACF;QACF;QAEA,iCAAiC;QACjC,IAAI,QAAQ,MAAM,GAAG,KAAK,qBAAqB,MAAM;YACnD,eAAe,OAAO,GAAG;YACzB,oBAAoB,OAAO,CAAC,EAAE,CAAC,EAAE;YACjC;QACF;QAEA,uBAAuB;QACvB,IAAI,qBAAqB,MAAM;YAC7B,eAAe,OAAO,GAAG;QAC3B;IACF,GAAG;QACD;QACA;QACA;QACA;QACA;KACD;IAED,yBAAyB;IACzB,IAAA,scAAS,EAAC;QACR,MAAM,eAAe,SAAS,MAAM;QAEpC,IACE,eAAe,oBAAoB,OAAO,IAC1C,eAAe,KACf,mBAAmB,OAAO,EAC1B;YACA,WAAW;gBACT,mBAAmB,OAAO,EAAE,SAAS;oBACnC,KAAK,mBAAmB,OAAO,CAAC,YAAY;oBAC5C,UAAU;gBACZ;YACF,GAAG;QACL;QAEA,oBAAoB,OAAO,GAAG;IAChC,GAAG;QAAC;KAAS;IAEb,qBACE,keAAC;QACC,WAAW,CAAC,iDAAiD,EAC3D,sBACI,kDACA,iBACJ;;0BAEF,keAAC,wNAAa;gBACZ,KAAK;gBACL,UAAU;gBACV,aAAa;;;;;;0BAEf,keAAC,gNAAS;gBACR,QAAQ,CAAC;oBACP,kDAAkD;oBAClD,KAAK,YAAY;gBACnB;gBACA,QAAQ;gBACR,WAAW;;;;;;0BAGb,keAAC,oOAAiB;gBAAC,aAAa;;;;;;YAC/B,uBAAS,keAAC;gBAAI,WAAU;0BAAgC;;;;;;;;;;;;AAG/D","debugId":null}}]
}